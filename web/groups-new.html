<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Groups - SysWatch</title>
    <link rel="stylesheet" href="/shared.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="/" class="navbar-brand">üñ•Ô∏è SysWatch Dashboard</a>
                <ul class="navbar-nav">
                    <li><a href="/" class="nav-link">Dashboard</a></li>
                    <li><a href="/groups.html" class="nav-link active">Groups</a></li>
                    <li><a href="/admin" class="nav-link">Admin</a></li>
                    <li><button onclick="logout()" class="btn btn-danger btn-sm">Logout</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="flex" style="gap: 2rem;">
            <!-- Groups List -->
            <div style="width: 300px; flex-shrink: 0;">
                <div class="card">
                    <div class="card-header">
                        <div class="flex flex-between">
                            <h3 class="card-title">Agent Groups</h3>
                            <button class="btn btn-primary btn-sm" onclick="showCreateGroupModal()">New Group</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="groupsList"></div>
                    </div>
                </div>
            </div>

            <!-- Group Details -->
            <div style="flex: 1;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Group Details</h3>
                    </div>
                    <div class="card-body">
                        <div id="groupDetails">
                            <p class="text-muted text-center">Select a group to view details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Create New Group</h3>
                    <button class="modal-close" onclick="closeModal('createGroupModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="form-group">
                            <label class="form-label">Group Name</label>
                            <input type="text" class="form-input" id="groupName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="groupDescription" rows="3" style="resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-input" id="groupColor" value="#2563eb" style="height: 3rem;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('createGroupModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="createGroup()">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Machine Modal -->
    <div id="addMachineModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add Machine to Group</h3>
                    <button class="modal-close" onclick="closeModal('addMachineModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Select Machine</label>
                        <select class="form-input" id="machineSelect">
                            <option value="">Choose a machine...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('addMachineModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addMachineToGroup()">Add Machine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Command Modal -->
    <div id="groupCommandModal" class="modal">
        <div class="modal-dialog" style="max-width: 600px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Execute Command on Group</h3>
                    <button class="modal-close" onclick="closeModal('groupCommandModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Command</label>
                        <input type="text" class="form-input" id="groupCommand" placeholder="Enter command to execute on all group members">
                    </div>
                    <div id="groupCommandResults"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('groupCommandModal')">Close</button>
                    <button class="btn btn-primary" onclick="executeGroupCommand()">Execute</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let groups = [];
        let machines = [];
        let selectedGroupId = null;

        // Load data
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                groups = await response.json();
                renderGroups();
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadMachines() {
            try {
                const response = await fetch('/api/machines');
                machines = await response.json();
            } catch (error) {
                console.error('Error loading machines:', error);
            }
        }

        // Render groups list
        function renderGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            groups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'p-3 rounded mb-2 cursor-pointer';
                groupElement.style.border = `2px solid ${group.color}`;
                groupElement.style.background = `${group.color}10`;
                groupElement.onclick = () => selectGroup(group.id);
                
                groupElement.innerHTML = `
                    <div class="flex flex-between">
                        <div>
                            <div style="font-weight: 600; color: ${group.color};">${group.name}</div>
                            <div class="text-muted">${group.member_count} members</div>
                        </div>
                        <div class="badge" style="background: ${group.color}; color: white;">${group.member_count}</div>
                    </div>
                    ${group.description ? `<div class="text-muted mt-1" style="font-size: 0.875rem;">${group.description}</div>` : ''}
                `;
                
                groupsList.appendChild(groupElement);
            });
        }

        // Select and display group details
        async function selectGroup(groupId) {
            selectedGroupId = groupId;
            const group = groups.find(g => g.id === groupId);
            
            try {
                const response = await fetch(`/api/groups/${groupId}/members`);
                const members = await response.json();
                
                const groupDetails = document.getElementById('groupDetails');
                groupDetails.innerHTML = `
                    <div class="flex flex-between mb-3">
                        <div>
                            <h4 style="color: ${group.color}; margin-bottom: 0.5rem;">${group.name}</h4>
                            ${group.description ? `<p class="text-muted">${group.description}</p>` : ''}
                        </div>
                        <div class="flex">
                            <button class="btn btn-primary btn-sm" onclick="showAddMachineModal()">Add Machine</button>
                            <button class="btn btn-success btn-sm" onclick="showGroupCommandModal()">Execute Command</button>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">Members (${members.length})</h5>
                    
                    ${members.length === 0 ? 
                        '<p class="text-muted text-center p-4">No machines in this group</p>' :
                        `<div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Hostname</th>
                                        <th>Platform</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${members.map(member => `
                                        <tr>
                                            <td style="font-weight: 500;">${member.hostname}</td>
                                            <td>${member.platform}</td>
                                            <td>
                                                <div class="flex" style="align-items: center; gap: 0.5rem;">
                                                    <div class="status-dot status-${member.status}"></div>
                                                    <span class="badge badge-${member.status === 'online' ? 'success' : 'danger'}">${member.status}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <button class="btn btn-danger btn-sm" onclick="removeMemberFromGroup('${member.id}')">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`
                    }
                `;
            } catch (error) {
                console.error('Error loading group members:', error);
            }
        }

        // Modal functions
        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'block';
        }

        function showAddMachineModal() {
            const machineSelect = document.getElementById('machineSelect');
            machineSelect.innerHTML = '<option value="">Choose a machine...</option>';
            
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.hostname} (${machine.platform})`;
                machineSelect.appendChild(option);
            });
            
            document.getElementById('addMachineModal').style.display = 'block';
        }

        function showGroupCommandModal() {
            document.getElementById('groupCommandModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Reset forms
            if (modalId === 'createGroupModal') {
                document.getElementById('createGroupForm').reset();
            }
            if (modalId === 'groupCommandModal') {
                document.getElementById('groupCommand').value = '';
                document.getElementById('groupCommandResults').innerHTML = '';
            }
        }

        // Group operations
        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;
            const color = document.getElementById('groupColor').value;

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, color })
                });

                const result = await response.json();
                if (result.success) {
                    closeModal('createGroupModal');
                    loadGroups();
                } else {
                    alert('Error creating group: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        }

        async function addMachineToGroup() {
            const machineId = document.getElementById('machineSelect').value;
            if (!machineId || !selectedGroupId) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });

                const result = await response.json();
                if (result.success) {
                    closeModal('addMachineModal');
                    selectGroup(selectedGroupId);
                    loadGroups();
                } else {
                    alert('Error adding machine to group: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding machine to group:', error);
                alert('Error adding machine to group');
            }
        }

        async function removeMemberFromGroup(machineId) {
            if (!confirm('Remove this machine from the group?')) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/members/${machineId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    selectGroup(selectedGroupId);
                    loadGroups();
                } else {
                    alert('Error removing machine from group: ' + result.error);
                }
            } catch (error) {
                console.error('Error removing machine from group:', error);
                alert('Error removing machine from group');
            }
        }

        async function executeGroupCommand() {
            const command = document.getElementById('groupCommand').value;
            if (!command || !selectedGroupId) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });

                const result = await response.json();
                const resultsDiv = document.getElementById('groupCommandResults');
                
                if (result.success) {
                    const sentCount = result.results.filter(r => r.status === 'sent').length;
                    resultsDiv.innerHTML = `
                        <div class="p-3 rounded mb-3" style="background: var(--success); color: white;">
                            Command sent to ${sentCount} machines
                        </div>
                        <table class="table">
                            <thead>
                                <tr><th>Machine</th><th>Status</th><th>Command ID</th></tr>
                            </thead>
                            <tbody>
                                ${result.results.map(r => `
                                    <tr>
                                        <td>${r.machineId}</td>
                                        <td><span class="badge badge-${r.status === 'sent' ? 'success' : 'warning'}">${r.status}</span></td>
                                        <td style="font-family: monospace; font-size: 0.875rem;">${r.commandId || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="p-3 rounded" style="background: var(--danger); color: white;">Error: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Error executing group command:', error);
                document.getElementById('groupCommandResults').innerHTML = 
                    `<div class="p-3 rounded" style="background: var(--danger); color: white;">Error executing command</div>`;
            }
        }

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login';
                });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGroups();
            loadMachines();
            
            // Close modals on outside click
            window.onclick = function(event) {
                const modals = ['createGroupModal', 'addMachineModal', 'groupCommandModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        closeModal(modalId);
                    }
                });
            };
        });
    </script>
</body>
</html>