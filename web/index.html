<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysWatch Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #212529;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --info-card-bg: #f8f9fa;
            --metric-bg: #e3f2fd;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1e1e1e;
                --card-bg: #252526;
                --text-color: #cccccc;
                --border-color: #3c3c3c;
                --shadow: 0 2px 4px rgba(0,0,0,0.5);
                --info-card-bg: #2d2d30;
                --metric-bg: #37373d;
            }
        }
        
        body { font-family: Arial, sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); }
        .content-wrapper { display: flex; }
        .sidebar { width: 250px; background: var(--card-bg); height: calc(100vh - 70px); box-shadow: var(--shadow); padding: 20px; overflow-y: auto; }
        .main-content { flex: 1; padding: 20px; }
        .header { background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .group { margin: 10px 0; padding: 10px; background: var(--info-card-bg); border-radius: 4px; cursor: pointer; }
        .group.active { background: #007cba; color: white; }
        .group-machines { font-size: 12px; color: #666; margin-top: 5px; }
        .group.active .group-machines { color: #ccc; }
        .group.active .machine-item { background: rgba(255,255,255,0.1); color: white; }
        .group.active .machine-item span { color: white; }
        .add-group { background: #4caf50; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
        .machine-item { display: flex; align-items: center; margin: 5px 0; padding: 5px; background: var(--card-bg); border-radius: 3px; font-size: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .status-online { background: #4caf50; }
        .status-offline { background: #f44336; }
        .assign-group { background: #2196f3; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px; cursor: pointer; }
        .machine { 
            background: var(--card-bg);
            border: 1px solid var(--border-color); 
            margin: 15px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: var(--shadow);
        }
        .online { border-left: 5px solid #4CAF50; }
        .offline { border-left: 5px solid #f44336; }
        .machine-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .system-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0; }
        .info-card { background: var(--info-card-bg); padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); }
        .info-card h4 { margin: 0 0 8px 0; color: var(--text-color); font-size: 14px; opacity: 0.8; }
        .info-value { font-size: 16px; font-weight: bold; color: var(--text-color); }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .metric { background: var(--metric-bg); padding: 10px; border-radius: 6px; text-align: center; }
        .metric-label { font-size: 12px; color: #666; }
        .metric-value { font-size: 18px; font-weight: bold; color: #1976d2; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .cpu-bar { background: #ff9800; }
        .memory-bar { background: #4caf50; }
        .disk-bar { background: #f44336; }
        .command-section { 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 2px solid #eee; 
        }
        input[type="text"] { 
            width: 300px; 
            padding: 8px; 
            margin-right: 10px; 
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-color);
        }
        button { 
            padding: 8px 16px; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { 
            margin-top: 10px; 
            padding: 12px; 
            background: var(--info-card-bg); 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            border: 1px solid var(--border-color);
        }
        .status { font-weight: bold; }
        .online-status { color: #4CAF50; }
        .offline-status { color: #f44336; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: var(--shadow); }
        .summary-number { font-size: 24px; font-weight: bold; }
        .summary-label { font-size: 12px; color: #666; margin-top: 5px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-close:hover { color: #000; }
        .modal-output { background: var(--info-card-bg); padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    
    <nav class="navbar navbar-expand-lg" style="background: var(--card-bg); padding: 15px 0; box-shadow: var(--shadow); margin-bottom: 20px;">
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
            <a class="navbar-brand" href="/" style="font-size: 20px; font-weight: bold; color: var(--text-color); text-decoration: none;">üñ•Ô∏è SysWatch Dashboard</a>
            <div class="navbar-nav" style="display: flex; list-style: none; margin: 0; padding: 0;">
                <a class="nav-link active" href="/" style="color: white; background: #007bff; text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px;">Dashboard</a>
                <a class="nav-link" href="/groups.html" style="color: var(--text-color); text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px;">Groups</a>
                <a class="nav-link" href="/admin" style="color: var(--text-color); text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px;">Admin</a>
                <button onclick="logout()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Logout</button>
            </div>
        </div>
    </nav>
    
    <div class="content-wrapper">
        <div class="sidebar">
            <h3>Machine Groups</h3>
            <div class="group active" onclick="selectGroup('all')">
                <div>All Machines</div>
                <div class="group-machines" id="all-count">0 machines</div>
            </div>
            <div id="groups-list"></div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <div class="update-controls" style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <button onclick="checkForUpdates()">Check for Updates</button>
                        <button onclick="updateAllAgents()">Update All Agents</button>
                        <button onclick="cleanupOfflineMachines()" style="background: #f44336;">Cleanup Offline</button>
                        <span id="update-status"></span>
                    </div>
                    <div>
                        <button onclick="toggleView()" id="viewToggle" style="background: #9c27b0;">Table View</button>
                    </div>
                </div>
                <div class="summary" id="summary"></div>
            </div>
            <div id="machines"></div>
        </div>
    </div>
    
    <!-- Modal for command output -->
    <div id="commandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Command Output</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalOutput" class="modal-output">Loading...</div>
        </div>
    </div>

    <script>
        let machines = [];
        let groups = {};
        let selectedGroup = 'all';
        let viewMode = 'cards'; // 'cards' or 'table'

        async function uninstallAgent(machineId) {
            const machine = machines.find(m => m.id === machineId);
            if (!machine) return;
            
            if (!confirm(`Are you sure you want to uninstall the SysWatch agent from ${machine.hostname}? This action cannot be undone and the machine will be removed from monitoring.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/uninstall-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Uninstall command sent to ${machine.hostname}. The agent will be removed shortly.`);
                    // Refresh machines list after a delay
                    setTimeout(loadMachines, 3000);
                } else {
                    alert(`Failed to send uninstall command: ${result.error}`);
                }
            } catch (error) {
                alert(`Uninstall request failed: ${error.message}`);
            }
        }
        
        async function cleanupOfflineMachines() {
            if (!confirm('Remove all offline machines? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/cleanup-offline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Removed ${result.count} offline machines`);
                    loadMachines(); // Refresh the list
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function loadMachines() {
            try {
                const response = await fetch('/api/machines');
                machines = await response.json();
                renderMachines();
            } catch (error) {
                console.error('Failed to load machines:', error);
            }
        }

        function toggleView() {
            viewMode = viewMode === 'cards' ? 'table' : 'cards';
            document.getElementById('viewToggle').textContent = viewMode === 'cards' ? 'Table View' : 'Card View';
            renderMachines();
        }
        
        function renderMachines() {
            renderSummary();
            
            const container = document.getElementById('machines');
            const filteredMachines = getFilteredMachines();
            
            if (viewMode === 'table') {
                renderTableView(container, filteredMachines);
                return;
            }
            
            // Store current input values and result visibility
            const inputValues = {};
            const resultStates = {};
            
            filteredMachines.forEach(machine => {
                const input = document.getElementById(`cmd-${machine.id}`);
                const result = document.getElementById(`result-${machine.id}`);
                if (input) inputValues[machine.id] = input.value;
                if (result) resultStates[machine.id] = {
                    display: result.style.display,
                    content: result.textContent
                };
            });
            
            container.innerHTML = '';

            if (filteredMachines.length === 0) {
                container.innerHTML = '<div class="machine"><p>No machines in this group</p></div>';
                return;
            }

            filteredMachines.forEach(machine => {
                const div = document.createElement('div');
                div.className = `machine ${machine.status}`;
                
                const lastSeen = new Date(machine.lastSeen).toLocaleString();
                const statusClass = machine.status === 'online' ? 'online-status' : 'offline-status';
                
                div.innerHTML = `
                    <div class="machine-header">
                        <div>
                            <h3>${machine.hostname}</h3>
                            <p><strong>Status:</strong> <span class="status ${statusClass}">${machine.status.toUpperCase()}</span> | <strong>Last Seen:</strong> ${lastSeen}</p>
                        </div>
                    </div>
                    
                    ${renderSystemInfo(machine)}
                    ${renderMetrics(machine)}
                    
                    <div class="quick-actions" style="margin: 15px 0;">
                        <h4>Quick Actions:</h4>
                        <button onclick="quickAction('${machine.id}', 'shutdown')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #f44336; margin-right: 5px;">Shutdown</button>
                        <button onclick="quickAction('${machine.id}', 'reboot')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #ff9800; margin-right: 5px;">Reboot</button>
                        <button onclick="quickAction('${machine.id}', 'processes')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #2196f3; margin-right: 5px;">Processes</button>
                        <button onclick="quickAction('${machine.id}', 'services')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #4caf50; margin-right: 5px;">Services</button>
                        <button onclick="quickAction('${machine.id}', 'network')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #9c27b0; margin-right: 5px;">Network</button>
                        <button onclick="quickAction('${machine.id}', 'software')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #607d8b; margin-right: 5px;">Software</button>
                        <button onclick="updateSingleAgent('${machine.id}')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #ff5722; margin-right: 5px;">Update</button>
                        <button onclick="uninstallAgent('${machine.id}')" 
                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                style="background: #f44336; margin-right: 5px;">Uninstall</button>
                    </div>
                    

                    
                    <div class="command-section">
                        <input type="text" id="cmd-${machine.id}" placeholder="Enter command..." 
                               ${machine.status === 'offline' ? 'disabled' : ''}>
                        <button onclick="executeCommand('${machine.id}')" 
                                ${machine.status === 'offline' ? 'disabled' : ''}>Execute</button>
                        <div id="result-${machine.id}" class="result" style="display: none;"></div>
                    </div>
                `;
                
                container.appendChild(div);
                
                // Restore input values and result states
                const input = document.getElementById(`cmd-${machine.id}`);
                const result = document.getElementById(`result-${machine.id}`);
                
                if (input && inputValues[machine.id]) {
                    input.value = inputValues[machine.id];
                }
                
                if (result && resultStates[machine.id]) {
                    result.style.display = resultStates[machine.id].display;
                    result.textContent = resultStates[machine.id].content;
                }
            });
        }
        
        function renderSummary() {
            const summary = document.getElementById('summary');
            const online = machines.filter(m => m.status === 'online').length;
            const offline = machines.length - online;
            
            summary.innerHTML = `
                <div class="summary-card">
                    <div class="summary-number" style="color: #4CAF50;">${online}</div>
                    <div class="summary-label">Online</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" style="color: #f44336;">${offline}</div>
                    <div class="summary-label">Offline</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${machines.length}</div>
                    <div class="summary-label">Total Machines</div>
                </div>
            `;
        }
        
        function renderSystemInfo(machine) {
            const info = machine.systemInfo || {};
            if (!info.cpu_count) return '<p><em>System information not available</em></p>';
            
            return `
                <div class="system-info">
                    <div class="info-card">
                        <h4>Platform</h4>
                        <div class="info-value">${machine.platform}</div>
                    </div>
                    <div class="info-card">
                        <h4>CPU Cores</h4>
                        <div class="info-value">${info.cpu_count}</div>
                    </div>
                    <div class="info-card">
                        <h4>Memory</h4>
                        <div class="info-value">${formatBytes(info.memory_total)}</div>
                    </div>
                    <div class="info-card">
                        <h4>Disk Space</h4>
                        <div class="info-value">${formatBytes(info.disk_total)}</div>
                    </div>
                    <div class="info-card">
                        <h4>Architecture</h4>
                        <div class="info-value">${info.architecture || 'Unknown'}</div>
                    </div>
                    <div class="info-card">
                        <h4>Uptime</h4>
                        <div class="info-value">${formatUptime(info.boot_time)}</div>
                    </div>
                    <div class="info-card">
                        <h4>Agent Version</h4>
                        <div class="info-value">${machine.agentVersion || 'Unknown'}</div>
                    </div>
                </div>
            `;
        }
        
        function renderMetrics(machine) {
            const metrics = machine.metrics || {};
            if (!metrics.cpu_percent) return '<p><em>No metrics data available</em></p>';
            
            const statusNote = machine.status === 'offline' ? '<p style="color: #f44336; font-size: 12px; margin-bottom: 10px;"><em>Last known metrics (machine offline)</em></p>' : '';
            
            return `
                ${statusNote}
                <div class="metrics">
                    <div class="metric" onclick="showMetricGraph('${machine.id}', 'cpu', '${machine.hostname}')" style="cursor: pointer;${machine.status === 'offline' ? 'opacity: 0.7;' : ''}">
                        <div class="metric-label">CPU Usage</div>
                        <div class="metric-value">${metrics.cpu_percent.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill cpu-bar" style="width: ${metrics.cpu_percent}%"></div>
                        </div>
                    </div>
                    <div class="metric" onclick="showMetricGraph('${machine.id}', 'memory', '${machine.hostname}')" style="cursor: pointer;${machine.status === 'offline' ? 'opacity: 0.7;' : ''}">
                        <div class="metric-label">Memory Usage</div>
                        <div class="metric-value">${metrics.memory_percent.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill memory-bar" style="width: ${metrics.memory_percent}%"></div>
                        </div>
                    </div>
                    <div class="metric" onclick="showMetricGraph('${machine.id}', 'disk', '${machine.hostname}')" style="cursor: pointer;${machine.status === 'offline' ? 'opacity: 0.7;' : ''}">
                        <div class="metric-label">Disk Usage</div>
                        <div class="metric-value">${metrics.disk_percent.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill disk-bar" style="width: ${metrics.disk_percent}%"></div>
                        </div>
                    </div>
                    <div class="metric" onclick="showMetricGraph('${machine.id}', 'process', '${machine.hostname}')" style="cursor: pointer;${machine.status === 'offline' ? 'opacity: 0.7;' : ''}">
                        <div class="metric-label">Processes</div>
                        <div class="metric-value">${metrics.process_count}</div>
                    </div>
                </div>
            `;
        }
        
        function formatBytes(bytes) {
            if (!bytes) return 'Unknown';
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        }
        
        function formatUptime(bootTime) {
            if (!bootTime) return 'Unknown';
            const uptime = Date.now() / 1000 - bootTime;
            const days = Math.floor(uptime / 86400);
            const hours = Math.floor((uptime % 86400) / 3600);
            return `${days}d ${hours}h`;
        }

        async function executeCommand(machineId) {
            const input = document.getElementById(`cmd-${machineId}`);
            const resultDiv = document.getElementById(`result-${machineId}`);
            const command = input.value.trim();
            
            if (!command) return;
            
            const machine = machines.find(m => m.id === machineId);
            
            // Show command in modal
            document.getElementById('modalTitle').textContent = `${machine.hostname} - ${command}`;
            document.getElementById('modalOutput').textContent = 'Executing command...';
            document.getElementById('commandModal').style.display = 'block';

            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId, command })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Poll for command result in modal
                    pollForCommandResult(result.commandId, machine.hostname);
                    
                    resultDiv.textContent = 'Command executed - see modal for results';
                    resultDiv.style.display = 'block';
                    input.value = '';
                } else {
                    document.getElementById('modalOutput').textContent = `Error: ${result.error}`;
                    resultDiv.textContent = `Error: ${result.error}`;
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                const errorMsg = `Error: ${error.message}`;
                document.getElementById('modalOutput').textContent = errorMsg;
                resultDiv.textContent = errorMsg;
                resultDiv.style.display = 'block';
            }
        }

        async function checkForUpdates() {
            const status = document.getElementById('update-status');
            status.textContent = 'Checking for updates...';
            
            try {
                const response = await fetch('/api/update-check');
                const result = await response.json();
                
                if (result.hasUpdate) {
                    status.textContent = `Update available: ${result.currentVersion} -> ${result.latestVersion}`;
                    status.style.color = '#ff9800';
                } else {
                    status.textContent = 'No updates available';
                    status.style.color = '#4caf50';
                }
            } catch (error) {
                status.textContent = `Update check failed: ${error.message}`;
                status.style.color = '#f44336';
            }
        }
        
        async function updateSingleAgent(machineId) {
            const machine = machines.find(m => m.id === machineId);
            if (!machine) return;
            
            if (!confirm(`Update agent on ${machine.hostname}?`)) return;
            
            try {
                const response = await fetch('/api/update-single-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show status and start monitoring
                    const statusSpan = document.createElement('span');
                    statusSpan.id = `update-status-${machineId}`;
                    statusSpan.style.cssText = 'color: #ff9800; font-size: 12px; margin-left: 10px;';
                    statusSpan.textContent = 'Updating...';
                    
                    const updateBtn = document.querySelector(`button[onclick="updateSingleAgent('${machineId}')"]`);
                    updateBtn.parentNode.appendChild(statusSpan);
                    updateBtn.disabled = true;
                    
                    // Monitor this specific agent's update
                    monitorSingleAgentUpdate(machineId, machine.hostname);
                } else {
                    alert(`Failed to send update request: ${result.error}`);
                }
            } catch (error) {
                alert(`Update request failed: ${error.message}`);
            }
        }
        
        async function updateAllAgents() {
            const status = document.getElementById('update-status');
            status.textContent = 'Sending update request to agents...';
            
            try {
                const response = await fetch('/api/update-agents', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    status.textContent = `Update request sent to ${result.agentsNotified} agents. Monitoring progress...`;
                    status.style.color = '#ff9800';
                    
                    // Start monitoring update progress
                    monitorUpdateProgress();
                } else {
                    status.textContent = 'Failed to send update request';
                    status.style.color = '#f44336';
                }
            } catch (error) {
                status.textContent = `Update request failed: ${error.message}`;
                status.style.color = '#f44336';
            }
        }
        
        async function monitorUpdateProgress() {
            const status = document.getElementById('update-status');
            let attempts = 0;
            const maxAttempts = 60; // 30 seconds
            
            const checkProgress = async () => {
                try {
                    const response = await fetch('/api/update-status');
                    const statuses = await response.json();
                    
                    if (statuses.length === 0 && attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkProgress, 500);
                        return;
                    }
                    
                    const summary = statuses.reduce((acc, s) => {
                        acc[s.status] = (acc[s.status] || 0) + 1;
                        return acc;
                    }, {});
                    
                    const total = statuses.length;
                    const completed = (summary.up_to_date || 0) + (summary.error || 0);
                    const updating = summary.updating || 0;
                    
                    if (completed === total) {
                        status.textContent = `Updates complete: ${summary.up_to_date || 0} up-to-date, ${summary.error || 0} errors`;
                        status.style.color = summary.error ? '#ff9800' : '#4caf50';
                    } else if (attempts < maxAttempts) {
                        status.textContent = `Updating: ${updating} in progress, ${completed}/${total} complete`;
                        attempts++;
                        setTimeout(checkProgress, 500);
                    } else {
                        status.textContent = 'Update monitoring timed out';
                        status.style.color = '#f44336';
                    }
                } catch (error) {
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkProgress, 500);
                    } else {
                        status.textContent = 'Failed to monitor update progress';
                        status.style.color = '#f44336';
                    }
                }
            };
            
            checkProgress();
        }
        
        async function monitorSingleAgentUpdate(machineId, hostname) {
            let attempts = 0;
            const maxAttempts = 60; // 30 seconds
            const statusSpan = document.getElementById(`update-status-${machineId}`);
            
            const checkStatus = async () => {
                try {
                    const response = await fetch('/api/update-status');
                    const statuses = await response.json();
                    const agentStatus = statuses.find(s => s.hostname === hostname);
                    
                    if (agentStatus) {
                        switch(agentStatus.status) {
                            case 'checking':
                                statusSpan.textContent = 'Checking for updates...';
                                statusSpan.style.color = '#ff9800';
                                break;
                            case 'updating':
                                statusSpan.textContent = `Updating to ${agentStatus.version}...`;
                                statusSpan.style.color = '#ff9800';
                                break;
                            case 'up_to_date':
                                statusSpan.textContent = 'Up to date';
                                statusSpan.style.color = '#4caf50';
                                setTimeout(() => statusSpan.remove(), 3000);
                                document.querySelector(`button[onclick="updateSingleAgent('${machineId}')"]`).disabled = false;
                                return;
                            case 'error':
                                statusSpan.textContent = `Error: ${agentStatus.error}`;
                                statusSpan.style.color = '#f44336';
                                setTimeout(() => statusSpan.remove(), 5000);
                                document.querySelector(`button[onclick="updateSingleAgent('${machineId}')"]`).disabled = false;
                                return;
                        }
                    }
                    
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkStatus, 500);
                    } else {
                        statusSpan.textContent = 'Update timeout';
                        statusSpan.style.color = '#f44336';
                        setTimeout(() => statusSpan.remove(), 3000);
                        document.querySelector(`button[onclick="updateSingleAgent('${machineId}')"]`).disabled = false;
                    }
                } catch (error) {
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkStatus, 500);
                    } else {
                        statusSpan.textContent = 'Status check failed';
                        statusSpan.style.color = '#f44336';
                        setTimeout(() => statusSpan.remove(), 3000);
                        document.querySelector(`button[onclick="updateSingleAgent('${machineId}')"]`).disabled = false;
                    }
                }
            };
            
            checkStatus();
        }

        function quickAction(machineId, action) {
            const commands = {
                'shutdown': {
                    'Windows': 'shutdown /s /t 30 /c "Remote shutdown in 30 seconds"',
                    'Linux': 'sudo shutdown -h +1 "Remote shutdown in 1 minute"'
                },
                'reboot': {
                    'Windows': 'shutdown /r /t 30',
                    'Linux': 'sudo reboot'
                },
                'processes': {
                    'Windows': 'tasklist /fo table',
                    'Linux': 'ps aux --sort=-%cpu | head -20'
                },
                'services': {
                    'Windows': 'sc query state= all',
                    'Linux': 'systemctl list-units --type=service --state=running'
                },
                'network': {
                    'Windows': 'ipconfig /all && netstat -an | findstr LISTEN',
                    'Linux': 'ip addr show && ss -tuln'
                },
                'software': {
                    'Windows': 'wmic product get name,version /format:table',
                    'Linux': 'dpkg -l | head -20'
                },

            };
            
            const machine = machines.find(m => m.id === machineId);
            if (!machine) return;
            
            const platform = machine.platform.includes('Windows') ? 'Windows' : 'Linux';
            const command = commands[action][platform];
            
            if (action === 'shutdown' || action === 'reboot') {
                if (!confirm(`Are you sure you want to ${action} ${machine.hostname}?`)) {
                    return;
                }
                executeCommandDirect(machineId, command, false);
            } else {
                // Show informational commands in modal
                executeCommandDirect(machineId, command, true);
            }
        }
        
        async function executeCommandDirect(machineId, command, showInModal = false) {
            const machine = machines.find(m => m.id === machineId);
            const resultDiv = document.getElementById(`result-${machineId}`);
            
            if (showInModal) {
                document.getElementById('modalTitle').textContent = `${machine.hostname} - ${command}`;
                document.getElementById('modalOutput').textContent = 'Executing command...';
                document.getElementById('commandModal').style.display = 'block';
            }
            
            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId, command })
                });

                const result = await response.json();
                
                if (result.success && showInModal) {
                    // Poll for command result
                    pollForCommandResult(result.commandId, machine.hostname);
                } else if (result.success) {
                    resultDiv.textContent = `Command sent: ${command}`;
                    resultDiv.style.display = 'block';
                } else {
                    const errorMsg = `Error: ${result.error}`;
                    if (showInModal) {
                        document.getElementById('modalOutput').textContent = errorMsg;
                    } else {
                        resultDiv.textContent = errorMsg;
                        resultDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                const errorMsg = `Error: ${error.message}`;
                if (showInModal) {
                    document.getElementById('modalOutput').textContent = errorMsg;
                } else {
                    resultDiv.textContent = errorMsg;
                    resultDiv.style.display = 'block';
                }
            }
        }
        
        async function pollForCommandResult(commandId, hostname) {
            let attempts = 0;
            const maxAttempts = 20; // 10 seconds max
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/command-result/${commandId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const result = data.result.result;
                        let output = '';
                        
                        if (result.stdout) output += result.stdout;
                        if (result.stderr) output += '\n--- STDERR ---\n' + result.stderr;
                        if (result.error) output = 'Error: ' + result.error;
                        if (result.returncode !== undefined) output += `\n--- Exit Code: ${result.returncode} ---`;
                        
                        // Add management buttons for processes or services
                        if (hostname && (result.stdout?.includes('PID') || result.stdout?.includes('USER'))) {
                            output += '\n\n--- Process Management ---\n';
                            output += 'Click on process names/IDs above to manage them.';
                            
                            const modalOutput = document.getElementById('modalOutput');
                            modalOutput.innerHTML = formatProcessOutput(output, hostname);
                        } else if (hostname && (result.stdout?.includes('SERVICE_NAME') || result.stdout?.includes('UNIT') || result.stdout?.includes('systemctl'))) {
                            output += '\n\n--- Service Management ---\n';
                            output += 'Click on service names above to manage them.';
                            
                            const modalOutput = document.getElementById('modalOutput');
                            modalOutput.innerHTML = formatServiceOutput(output, hostname);
                        } else {
                            document.getElementById('modalOutput').textContent = output || 'No output';
                        }
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 500);
                    } else {
                        document.getElementById('modalOutput').textContent = 'Command timed out or no response received';
                    }
                } catch (error) {
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 500);
                    } else {
                        document.getElementById('modalOutput').textContent = 'Failed to retrieve command result';
                    }
                }
            };
            
            poll();
        }
        
        function formatProcessOutput(output, hostname) {
            const machine = machines.find(m => m.hostname === hostname);
            const isWindows = machine?.platform.includes('Windows');
            
            // Convert process list to clickable format
            let formattedOutput = output.replace(/\n/g, '<br>');
            
            if (isWindows) {
                // Windows: Match process names and PIDs
                formattedOutput = formattedOutput.replace(
                    /(\w+\.exe)\s+(\d+)/g,
                    '<span class="process-item" onclick="manageProcess(\'$1\', \'$2\', \'$hostname\')" style="color: #007cba; cursor: pointer; text-decoration: underline;">$1 ($2)</span>'
                );
            } else {
                // Linux: Match any PID (number) in ps output
                formattedOutput = formattedOutput.replace(
                    /\b(\d{3,})\b/g,
                    '<span class="process-item" onclick="manageProcess(\'PID\', \'$1\', \''+hostname+'\')" style="color: #007cba; cursor: pointer; text-decoration: underline;">$1</span>'
                );
            }
            
            return formattedOutput;
        }
        
        function manageProcess(processName, pid, hostname) {
            const machine = machines.find(m => m.hostname === hostname);
            const isWindows = machine?.platform.includes('Windows');
            
            const actions = isWindows ? 
                ['Stop Process', 'Restart Process'] : 
                ['Stop Process', 'Kill Process', 'Restart Process'];
            
            const action = prompt(`Manage ${processName} (PID: ${pid}):\n\n${actions.map((a, i) => `${i+1}. ${a}`).join('\n')}\n\nEnter number:`);
            
            if (!action || isNaN(action) || action < 1 || action > actions.length) return;
            
            let command;
            if (isWindows) {
                switch(parseInt(action)) {
                    case 1: command = `taskkill /PID ${pid} /F`; break;
                    case 2: command = `taskkill /PID ${pid} /F && start "" "${processName}"`; break;
                }
            } else {
                switch(parseInt(action)) {
                    case 1: command = `kill ${pid}`; break;
                    case 2: command = `kill -9 ${pid}`; break;
                    case 3: command = `kill -HUP ${pid}`; break;
                }
            }
            
            if (command && confirm(`Execute: ${command}?`)) {
                executeCommandDirect(machine.id, command, true);
            }
        }
        
        function formatServiceOutput(output, hostname) {
            const machine = machines.find(m => m.hostname === hostname);
            const isWindows = machine?.platform.includes('Windows');
            
            let formattedOutput = output;
            
            if (isWindows) {
                // Windows: Match service names in sc query output BEFORE converting newlines
                formattedOutput = formattedOutput.replace(
                    /SERVICE_NAME: ([^\n\r]+)/g,
                    (match, serviceName) => {
                        const cleanName = serviceName.trim();
                        return `SERVICE_NAME: <span class="service-item" data-service="${cleanName}" data-hostname="${hostname}" style="color: #007cba; cursor: pointer; text-decoration: underline;">${cleanName}</span>`;
                    }
                );
            } else {
                // Linux: Match systemd service names (including hyphens, dots, etc.)
                formattedOutput = formattedOutput.replace(
                    /([\w.-]+\.service)/g,
                    '<span class="service-item" onclick="manageService(\'$1\', \''+hostname+'\')" style="color: #007cba; cursor: pointer; text-decoration: underline;">$1</span>'
                );
            }
            
            // Convert newlines to br tags AFTER regex processing
            formattedOutput = formattedOutput.replace(/\n/g, '<br>');
            
            return formattedOutput;
        }
        
        function manageService(serviceName, hostname) {
            const machine = machines.find(m => m.hostname === hostname);
            const isWindows = machine?.platform.includes('Windows');
            
            const actions = ['Start Service', 'Stop Service', 'Restart Service', 'Service Status'];
            
            const action = prompt(`Manage ${serviceName}:\n\n${actions.map((a, i) => `${i+1}. ${a}`).join('\n')}\n\nEnter number:`);
            
            if (!action || isNaN(action) || action < 1 || action > actions.length) return;
            
            let command;
            if (isWindows) {
                switch(parseInt(action)) {
                    case 1: command = `sc start "${serviceName}"`; break;
                    case 2: command = `sc stop "${serviceName}"`; break;
                    case 3: command = `sc stop "${serviceName}" && timeout /t 2 && sc start "${serviceName}"`; break;
                    case 4: command = `sc query "${serviceName}"`; break;
                }
            } else {
                switch(parseInt(action)) {
                    case 1: command = `sudo systemctl start ${serviceName}`; break;
                    case 2: command = `sudo systemctl stop ${serviceName}`; break;
                    case 3: command = `sudo systemctl restart ${serviceName}`; break;
                    case 4: command = `systemctl status ${serviceName}`; break;
                }
            }
            
            if (command && confirm(`Execute: ${command}?`)) {
                executeCommandDirect(machine.id, command, true);
            }
        }
        
        function closeModal() {
            // Close command modal
            const commandModal = document.getElementById('commandModal');
            if (commandModal) {
                commandModal.style.display = 'none';
            }
            
            // Close assign modal
            const assignModal = document.getElementById('assignModal');
            if (assignModal) {
                document.body.removeChild(assignModal);
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('commandModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function selectGroup(groupName) {
            selectedGroup = groupName;
            document.querySelectorAll('.group').forEach(g => g.classList.remove('active'));
            event.target.closest('.group').classList.add('active');
            renderMachines();
        }
        

        
        async function loadDatabaseGroups() {
            try {
                const response = await fetch('/api/groups');
                const dbGroups = await response.json();
                
                // Convert database groups to sidebar format
                groups = { 'Unknown': [] };
                for (const group of dbGroups) {
                    const membersResponse = await fetch(`/api/groups/${group.id}/members`);
                    const members = await membersResponse.json();
                    groups[group.name] = members.map(m => m.hostname);
                }
            } catch (error) {
                console.error('Failed to load database groups:', error);
                groups = { 'Unknown': [] };
            }
        }
        
        function renderGroups() {
            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';
            
            Object.keys(groups).forEach(groupName => {
                let groupMachines;
                if (groupName === 'Unknown') {
                    groupMachines = machines.filter(m => {
                        const inAnyGroup = Object.keys(groups).some(g => g !== 'Unknown' && groups[g].includes(m.hostname));
                        return !inAnyGroup;
                    });
                } else {
                    groupMachines = machines.filter(m => groups[groupName]?.includes(m.hostname));
                }
                const onlineCount = groupMachines.filter(m => m.status === 'online').length;
                
                const div = document.createElement('div');
                div.className = 'group';
                if (selectedGroup === groupName) div.classList.add('active');
                div.onclick = () => selectGroup(groupName);
                
                const machinesList = groupMachines.map(m => 
                    `<div class="machine-item">
                        <div class="status-dot status-${m.status}"></div>
                        <span>${m.hostname}</span>
                        <button class="assign-group" onclick="event.stopPropagation(); assignMachine('${m.hostname}')">Move</button>
                    </div>`
                ).join('');
                
                div.innerHTML = `
                    <div>${groupName}</div>
                    <div class="group-machines">${onlineCount}/${groupMachines.length} online</div>
                    ${machinesList}
                `;
                groupsList.appendChild(div);
            });
            
            // Update All Machines group
            const allOnline = machines.filter(m => m.status === 'online').length;
            const allMachinesList = machines.map(m => {
                const currentGroup = Object.keys(groups).find(g => groups[g].includes(m.hostname)) || 'Unknown';
                return `<div class="machine-item">
                    <div class="status-dot status-${m.status}"></div>
                    <span>${m.hostname}</span>
                    <button class="assign-group" onclick="event.stopPropagation(); assignMachine('${m.hostname}')">${currentGroup}</button>
                </div>`;
            }).join('');
            
            const allGroupDiv = document.querySelector('.group');
            allGroupDiv.innerHTML = `
                <div>All Machines</div>
                <div class="group-machines">${allOnline}/${machines.length} online</div>
                ${allMachinesList}
            `;
        }
        
        function getFilteredMachines() {
            if (selectedGroup === 'all') return machines;
            if (selectedGroup === 'Unknown') {
                return machines.filter(m => {
                    // Check if machine is in any non-Unknown group
                    const inAnyGroup = Object.keys(groups).some(g => g !== 'Unknown' && groups[g].includes(m.hostname));
                    return !inAnyGroup;
                });
            }
            return machines.filter(m => groups[selectedGroup]?.includes(m.hostname));
        }
        
        function assignMachine(hostname) {
            const groupNames = Object.keys(groups);
            const currentGroup = groupNames.find(g => groups[g].includes(hostname)) || 'Unknown';
            
            // Create dropdown options
            const options = groupNames.map(g => 
                `<option value="${g}" ${g === currentGroup ? 'selected' : ''}>${g}</option>`
            ).join('');
            
            const modal = document.createElement('div');
            modal.id = 'assignModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';
            modal.innerHTML = `
                <div style="background:var(--card-bg);padding:20px;border-radius:8px;min-width:300px;position:relative;color:var(--text-color)">
                    <button onclick="closeAssignModal()" style="position:absolute;top:10px;right:15px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-color);opacity:0.7">&times;</button>
                    <h3>Move ${hostname}</h3>
                    <p>Current group: <strong>${currentGroup}</strong></p>
                    <select id="groupSelect" style="width:100%;padding:8px;margin:10px 0;background:var(--card-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px">
                        ${options}
                    </select>
                    <div style="text-align:right;margin-top:15px">
                        <button onclick="closeAssignModal()" style="margin-right:10px;padding:8px 15px">Cancel</button>
                        <button onclick="moveToGroup('${hostname}')" style="background:#4caf50;color:white;border:none;padding:8px 15px;border-radius:4px">Move</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function moveToGroup(hostname) {
            const newGroup = document.getElementById('groupSelect').value;
            
            // Remove from all groups
            Object.keys(groups).forEach(g => {
                groups[g] = groups[g].filter(h => h !== hostname);
            });
            
            // Add to new group (except Unknown)
            if (newGroup !== 'Unknown') {
                groups[newGroup].push(hostname);
            }
            
            // Find group ID and update database
            try {
                const groupsResponse = await fetch('/api/groups');
                const dbGroups = await groupsResponse.json();
                const targetGroup = dbGroups.find(g => g.name === newGroup);
                
                if (targetGroup && newGroup !== 'Unknown') {
                    await fetch(`/api/groups/${targetGroup.id}/members`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ machineId: hostname })
                    });
                }
                
                // Remove from old groups in database
                for (const dbGroup of dbGroups) {
                    if (dbGroup.name !== newGroup) {
                        await fetch(`/api/groups/${dbGroup.id}/members/${hostname}`, {
                            method: 'DELETE'
                        });
                    }
                }
                
                await loadDatabaseGroups();
            } catch (error) {
                console.error('Error updating group membership:', error);
            }
            
            closeAssignModal();
            renderGroups();
            renderMachines();
        }
        
        function closeAssignModal() {
            const modal = document.getElementById('assignModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // Add click handler for service items
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('service-item')) {
                const serviceName = e.target.getAttribute('data-service');
                const hostname = e.target.getAttribute('data-hostname');
                if (serviceName && hostname) {
                    manageService(serviceName, hostname);
                }
            }
        });
        
        async function showMetricGraph(machineId, metricType, hostname) {
            // Store for modal refresh
            window.currentMachineId = machineId;
            window.currentMetricType = metricType;
            
            try {
                const response = await fetch(`/api/metrics/${machineId}`);
                const metrics = await response.json();
                
                if (metrics.error) {
                    console.error('Failed to load metrics:', metrics.error);
                    return;
                }
                
                // Prepare data based on metric type
                const labels = metrics.map(m => new Date(m.timestamp).toLocaleString());
                let data, label, color;
                
                switch(metricType) {
                    case 'cpu':
                        data = metrics.map(m => m.cpu_percent);
                        label = 'CPU Usage (%)';
                        color = '#ff9800';
                        break;
                    case 'memory':
                        data = metrics.map(m => m.memory_percent);
                        label = 'Memory Usage (%)';
                        color = '#4caf50';
                        break;
                    case 'disk':
                        data = metrics.map(m => m.disk_percent);
                        label = 'Disk Usage (%)';
                        color = '#f44336';
                        break;
                    case 'process':
                        data = metrics.map(m => m.process_count);
                        label = 'Process Count';
                        color = '#2196f3';
                        break;
                }
                
                // Show modal with graph
                showGraphModal(hostname, label, labels, data, color);
                
            } catch (error) {
                console.error('Failed to load metric graph:', error);
            }
        }
        
        function showGraphModal(hostname, label, labels, data, color) {
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';
            modal.innerHTML = `
                <div style="background:var(--card-bg);padding:20px;border-radius:8px;width:80%;max-width:800px;max-height:80vh;overflow-y:auto;position:relative">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h3 style="color:var(--text-color);margin:0">${hostname} - ${label} (Last 24 Hours)</h3>
                        <div>
                            <button style="background:#4caf50;color:white;border:none;padding:8px 12px;border-radius:4px;margin-right:10px;cursor:pointer">Refresh</button>
                            <button id="realtimeBtn" style="background:#2196f3;color:white;border:none;padding:8px 12px;border-radius:4px;margin-right:10px;cursor:pointer">Real-time: OFF</button>
                            <button id="closeBtn" style="background:#f44336;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer">Close</button>
                        </div>
                    </div>
                    <canvas id="modalChart" style="max-height:400px;width:100%"></canvas>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store modal reference
            window.currentModalElement = modal;
            
            // Add event listeners
            modal.querySelector('#closeBtn').addEventListener('click', closeGraphModal);
            modal.querySelector('button[style*="#4caf50"]').addEventListener('click', refreshGraph);
            modal.querySelector('#realtimeBtn').addEventListener('click', toggleRealtime);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeGraphModal();
            });
            document.body.appendChild(modal);
            
            // Store modal data for refresh/realtime
            window.currentModal = {
                hostname,
                label,
                color,
                machineId: window.currentMachineId,
                metricType: window.currentMetricType,
                isRealtime: false,
                interval: null
            };
            
            // Create chart
            createModalChart(labels, data, label, color);
        }
        
        function createModalChart(labels, data, label, color) {
            const canvas = document.getElementById('modalChart');
            if (!canvas) return;
            
            // Destroy existing chart
            if (window.modalChart && typeof window.modalChart.destroy === 'function') {
                window.modalChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            window.modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: label.includes('%') ? 100 : undefined
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
        }
        
        async function refreshGraph() {
            if (!window.currentModal) return;
            
            try {
                const response = await fetch(`/api/metrics/${window.currentModal.machineId}`);
                const metrics = await response.json();
                
                if (metrics.error) {
                    console.error('Metrics error:', metrics.error);
                    return;
                }
                
                if (!metrics || metrics.length === 0) {
                    console.log('No metrics data available');
                    return;
                }
                
                const labels = metrics.map(m => new Date(m.timestamp).toLocaleString());
                let data;
                
                switch(window.currentModal.metricType) {
                    case 'cpu': data = metrics.map(m => m.cpu_percent); break;
                    case 'memory': data = metrics.map(m => m.memory_percent); break;
                    case 'disk': data = metrics.map(m => m.disk_percent); break;
                    case 'process': data = metrics.map(m => m.process_count); break;
                }
                
                createModalChart(labels, data, window.currentModal.label, window.currentModal.color);
            } catch (error) {
                console.error('Failed to refresh graph:', error);
            }
        }
        
        function toggleRealtime() {
            if (!window.currentModal) return;
            
            const btn = document.getElementById('realtimeBtn');
            
            if (window.currentModal.isRealtime) {
                // Turn off real-time
                clearInterval(window.currentModal.interval);
                window.currentModal.isRealtime = false;
                btn.textContent = 'Real-time: OFF';
                btn.style.background = '#2196f3';
            } else {
                // Turn on real-time
                window.currentModal.isRealtime = true;
                btn.textContent = 'Real-time: ON';
                btn.style.background = '#ff9800';
                
                // Refresh every 10 seconds
                window.currentModal.interval = setInterval(refreshGraph, 10000);
            }
        }
        
        function closeGraphModal() {
            // Clean up real-time interval
            if (window.currentModal?.interval) {
                clearInterval(window.currentModal.interval);
            }
            
            // Destroy chart
            if (window.modalChart && typeof window.modalChart.destroy === 'function') {
                window.modalChart.destroy();
                window.modalChart = null;
            }
            
            // Remove modal using stored reference
            if (window.currentModalElement) {
                window.currentModalElement.remove();
                window.currentModalElement = null;
            }
            
            window.currentModal = null;
        }
        
        // Auto-refresh every 10 seconds (slower to reduce interference)
        setInterval(() => {
            loadMachines();
            renderGroups();
        }, 10000);
        
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login';
                });
        }
        
        function renderTableView(container, filteredMachines) {
            if (filteredMachines.length === 0) {
                container.innerHTML = '<div class="machine"><p>No machines in this group</p></div>';
                return;
            }
            
            const tableHtml = `
                <table class="machines-table">
                    <thead>
                        <tr>
                            <th>Machine</th>
                            <th>Status</th>
                            <th>Platform</th>
                            <th>CPU</th>
                            <th>Memory</th>
                            <th>Disk</th>
                            <th>Processes</th>
                            <th>Last Seen</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredMachines.map(machine => {
                            const lastSeen = new Date(machine.lastSeen).toLocaleString();
                            const statusClass = machine.status === 'online' ? 'online-status' : 'offline-status';
                            const metrics = machine.metrics || {};
                            
                            return `
                                <tr>
                                    <td><strong>${machine.hostname}</strong></td>
                                    <td>
                                        <div class="status-cell">
                                            <div class="status-dot status-${machine.status}"></div>
                                            <span class="${statusClass}">${machine.status.toUpperCase()}</span>
                                        </div>
                                    </td>
                                    <td>${machine.platform}</td>
                                    <td class="metric-cell">
                                        ${metrics.cpu_percent ? 
                                            `<div onclick="showMetricGraph('${machine.id}', 'cpu', '${machine.hostname}')" style="cursor: pointer;">
                                                ${metrics.cpu_percent.toFixed(1)}%
                                                <div class="progress-bar" style="width: 50px; height: 4px; margin-top: 2px;">
                                                    <div class="progress-fill cpu-bar" style="width: ${metrics.cpu_percent}%"></div>
                                                </div>
                                            </div>` : 'N/A'
                                        }
                                    </td>
                                    <td class="metric-cell">
                                        ${metrics.memory_percent ? 
                                            `<div onclick="showMetricGraph('${machine.id}', 'memory', '${machine.hostname}')" style="cursor: pointer;">
                                                ${metrics.memory_percent.toFixed(1)}%
                                                <div class="progress-bar" style="width: 50px; height: 4px; margin-top: 2px;">
                                                    <div class="progress-fill memory-bar" style="width: ${metrics.memory_percent}%"></div>
                                                </div>
                                            </div>` : 'N/A'
                                        }
                                    </td>
                                    <td class="metric-cell">
                                        ${metrics.disk_percent ? 
                                            `<div onclick="showMetricGraph('${machine.id}', 'disk', '${machine.hostname}')" style="cursor: pointer;">
                                                ${metrics.disk_percent.toFixed(1)}%
                                                <div class="progress-bar" style="width: 50px; height: 4px; margin-top: 2px;">
                                                    <div class="progress-fill disk-bar" style="width: ${metrics.disk_percent}%"></div>
                                                </div>
                                            </div>` : 'N/A'
                                        }
                                    </td>
                                    <td class="metric-cell">
                                        ${metrics.process_count ? 
                                            `<div onclick="showMetricGraph('${machine.id}', 'process', '${machine.hostname}')" style="cursor: pointer;">
                                                ${metrics.process_count}
                                            </div>` : 'N/A'
                                        }
                                    </td>
                                    <td style="font-size: 12px;">${lastSeen}</td>
                                    <td class="actions-cell">
                                        <button onclick="quickAction('${machine.id}', 'processes')" 
                                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                                style="background: #2196f3;">Proc</button>
                                        <button onclick="quickAction('${machine.id}', 'services')" 
                                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                                style="background: #4caf50;">Svc</button>
                                        <button onclick="updateSingleAgent('${machine.id}')" 
                                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                                style="background: #ff5722;">Upd</button>
                                        <button onclick="quickAction('${machine.id}', 'reboot')" 
                                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                                style="background: #ff9800;">Reb</button>
                                        <button onclick="uninstallAgent('${machine.id}')" 
                                                ${machine.status === 'offline' ? 'disabled' : ''} 
                                                style="background: #f44336;">Uninst</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        // Check authentication on load
        fetch('/api/machines')
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                // Initial load
                loadMachines();
                loadDatabaseGroups().then(() => {
                    renderGroups();
                });
            })
            .catch(() => {
                window.location.href = '/login';
            });
    </script>
</body>
</html>