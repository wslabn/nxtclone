<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysWatch Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/shared.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="/" class="navbar-brand">üñ•Ô∏è SysWatch Dashboard</a>
                <ul class="navbar-nav">
                    <li><a href="/" class="nav-link active">Dashboard</a></li>
                    <li><a href="/groups.html" class="nav-link">Groups</a></li>
                    <li><a href="/admin" class="nav-link">Admin</a></li>
                    <li><button onclick="logout()" class="btn btn-danger btn-sm">Logout</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="flex flex-between flex-wrap">
                    <div class="flex flex-wrap">
                        <button onclick="checkForUpdates()" class="btn btn-primary">Check Updates</button>
                        <button onclick="updateAllAgents()" class="btn btn-success">Update All</button>
                        <button onclick="cleanupOfflineMachines()" class="btn btn-danger">Cleanup Offline</button>
                        <button onclick="toggleView()" id="viewToggle" class="btn btn-info">Table View</button>
                    </div>
                    <div id="update-status" class="text-muted"></div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-4 mb-4" id="summary"></div>

        <!-- Sidebar & Main Content -->
        <div class="flex" style="gap: 2rem;">
            <!-- Sidebar -->
            <div style="width: 250px; flex-shrink: 0;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Machine Groups</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <input type="text" id="searchInput" class="form-input" placeholder="Search machines or groups..." oninput="filterContent()">
                        </div>
                        <div class="group active cursor-pointer p-2 rounded mb-2" onclick="selectGroup('all', this)" id="all-group">
                            <div id="all-title">All Machines</div>
                            <div class="text-muted" id="all-count">0 machines</div>
                        </div>
                        <div id="groups-list"></div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div style="flex: 1;">
                <div id="machines"></div>
            </div>
        </div>
    </div>

    <!-- Command Modal -->
    <div id="commandModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Command Output</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="modalOutput" style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Configuration Modal -->
    <div id="alertsModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="alertsModalTitle">Configure Alerts</h3>
                    <button class="modal-close" onclick="closeAlertsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="alertsForm">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="alertsEnabled" style="margin-right: 0.5rem;">
                                Enable Alerts for this Machine
                            </label>
                        </div>
                        
                        <div id="alertsConfig" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">CPU Usage Alert (%)</label>
                                <input type="number" id="cpuThreshold" class="form-input" min="1" max="100" value="90">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Memory Usage Alert (%)</label>
                                <input type="number" id="memoryThreshold" class="form-input" min="1" max="100" value="90">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Disk Usage Alert (%)</label>
                                <input type="number" id="diskThreshold" class="form-input" min="1" max="100" value="90">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="offlineAlert" style="margin-right: 0.5rem;">
                                    Alert when machine goes offline
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="onlineAlert" style="margin-right: 0.5rem;">
                                    Alert when machine comes back online
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAlertsModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveAlerts()">Save Alerts</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let machines = [];
        let groups = {};
        let selectedGroup = 'all';
        let viewMode = 'cards';

        // Machine management functions
        async function uninstallAgent(machineId) {
            const machine = machines.find(m => m.id === machineId);
            if (!machine) return;
            
            if (!confirm(`Uninstall SysWatch agent from ${machine.hostname}?`)) return;
            
            try {
                const response = await fetch('/api/uninstall-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`Uninstall command sent to ${machine.hostname}`);
                    setTimeout(loadMachines, 3000);
                } else {
                    alert(`Failed: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function cleanupOfflineMachines() {
            if (!confirm('Remove all offline machines?')) return;
            
            try {
                const response = await fetch('/api/cleanup-offline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`Removed ${result.count} offline machines`);
                    loadMachines();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function loadMachines() {
            try {
                const response = await fetch('/api/machines');
                machines = await response.json();
                renderMachines();
            } catch (error) {
                console.error('Failed to load machines:', error);
            }
        }

        function toggleView() {
            viewMode = viewMode === 'cards' ? 'table' : 'cards';
            document.getElementById('viewToggle').textContent = viewMode === 'cards' ? 'Table View' : 'Card View';
            renderMachines();
        }

        function renderMachines() {
            renderSummary();
            const container = document.getElementById('machines');
            
            // Check if search is active
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase();
            let filteredMachines;
            
            if (searchTerm) {
                // Use search filtering
                filteredMachines = machines.filter(machine => 
                    machine.hostname.toLowerCase().includes(searchTerm) ||
                    machine.platform.toLowerCase().includes(searchTerm)
                );
            } else {
                // Use group filtering
                filteredMachines = getFilteredMachines();
            }
            
            if (viewMode === 'table') {
                renderTableView(container, filteredMachines);
                return;
            }
            
            container.innerHTML = '';
            
            if (filteredMachines.length === 0) {
                container.innerHTML = '<div class="card"><div class="card-body text-center text-muted">No machines in this group</div></div>';
                return;
            }

            filteredMachines.forEach(machine => {
                const machineCard = document.createElement('div');
                machineCard.className = 'card mb-3';
                machineCard.style.borderLeft = `4px solid ${machine.status === 'online' ? 'var(--success)' : 'var(--danger)'}`;
                
                const lastSeen = new Date(machine.lastSeen).toLocaleString();
                
                machineCard.innerHTML = `
                    <div class="card-header">
                        <div class="flex flex-between">
                            <div>
                                <h3 class="card-title">${machine.hostname}</h3>
                                <div class="flex" style="align-items: center; gap: 0.5rem;">
                                    <div class="status-dot status-${machine.status}"></div>
                                    <span class="badge badge-${machine.status === 'online' ? 'success' : 'danger'}">${machine.status.toUpperCase()}</span>
                                    <span class="text-muted">Last seen: ${lastSeen}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        ${renderSystemInfo(machine)}
                        ${renderMetrics(machine)}
                        ${renderQuickActions(machine)}
                        ${renderCommandSection(machine)}
                    </div>
                `;
                
                container.appendChild(machineCard);
            });
        }

        function renderSummary() {
            const summary = document.getElementById('summary');
            const online = machines.filter(m => m.status === 'online').length;
            const offline = machines.length - online;
            
            summary.innerHTML = `
                <div class="card text-center">
                    <div class="card-body">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--success);">${online}</div>
                        <div class="text-muted">Online</div>
                    </div>
                </div>
                <div class="card text-center">
                    <div class="card-body">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--danger);">${offline}</div>
                        <div class="text-muted">Offline</div>
                    </div>
                </div>
                <div class="card text-center">
                    <div class="card-body">
                        <div style="font-size: 2rem; font-weight: bold;">${machines.length}</div>
                        <div class="text-muted">Total</div>
                    </div>
                </div>
                <div class="card text-center">
                    <div class="card-body">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--info);">${Object.keys(groups).length}</div>
                        <div class="text-muted">Groups</div>
                    </div>
                </div>
            `;
        }

        function renderSystemInfo(machine) {
            const info = machine.systemInfo || {};
            if (!info.cpu_count) return '<p class="text-muted">System information not available</p>';
            
            return `
                <div class="grid grid-3 mb-3">
                    <div><strong>Platform:</strong> ${machine.platform}</div>
                    <div><strong>CPU:</strong> ${info.cpu_count} cores</div>
                    <div><strong>Memory:</strong> ${formatBytes(info.memory_total)}</div>
                    <div><strong>Disk:</strong> ${formatBytes(info.disk_total)}</div>
                    <div><strong>Architecture:</strong> ${info.architecture || 'Unknown'}</div>
                    <div><strong>Agent:</strong> v${machine.agentVersion || 'Unknown'}</div>
                </div>
            `;
        }

        function renderMetrics(machine) {
            const metrics = machine.metrics || {};
            if (!metrics.cpu_percent) return '<p class="text-muted">No metrics available</p>';
            
            return `
                <div class="grid grid-4 mb-3">
                    <div class="cursor-pointer" onclick="showMetricGraph('${machine.id}', 'cpu', '${machine.hostname}')">
                        <div class="text-muted mb-1">CPU Usage</div>
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">${metrics.cpu_percent.toFixed(1)}%</div>
                        <div class="progress">
                            <div class="progress-bar progress-cpu" style="width: ${metrics.cpu_percent}%"></div>
                        </div>
                    </div>
                    <div class="cursor-pointer" onclick="showMetricGraph('${machine.id}', 'memory', '${machine.hostname}')">
                        <div class="text-muted mb-1">Memory Usage</div>
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">${metrics.memory_percent.toFixed(1)}%</div>
                        <div class="progress">
                            <div class="progress-bar progress-memory" style="width: ${metrics.memory_percent}%"></div>
                        </div>
                    </div>
                    <div class="cursor-pointer" onclick="showMetricGraph('${machine.id}', 'disk', '${machine.hostname}')">
                        <div class="text-muted mb-1">Disk Usage</div>
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">${metrics.disk_percent.toFixed(1)}%</div>
                        <div class="progress">
                            <div class="progress-bar progress-disk" style="width: ${metrics.disk_percent}%"></div>
                        </div>
                    </div>
                    <div class="cursor-pointer" onclick="showMetricGraph('${machine.id}', 'process', '${machine.hostname}')">
                        <div class="text-muted mb-1">Processes</div>
                        <div style="font-weight: bold;">${metrics.process_count}</div>
                    </div>
                </div>
            `;
        }

        function renderQuickActions(machine) {
            const disabled = machine.status === 'offline';
            const isWindows = machine.platform.includes('Windows');
            
            return `
                <div class="flex flex-wrap mb-3">
                    <button onclick="quickAction('${machine.id}', 'shutdown')" ${disabled ? 'disabled' : ''} class="btn btn-danger btn-sm">Shutdown</button>
                    <button onclick="quickAction('${machine.id}', 'reboot')" ${disabled ? 'disabled' : ''} class="btn btn-warning btn-sm">Reboot</button>
                    <button onclick="quickAction('${machine.id}', 'processes')" ${disabled ? 'disabled' : ''} class="btn btn-info btn-sm">Processes</button>
                    <button onclick="quickAction('${machine.id}', 'services')" ${disabled ? 'disabled' : ''} class="btn btn-success btn-sm">Services</button>
                    <button onclick="quickAction('${machine.id}', 'network')" ${disabled ? 'disabled' : ''} class="btn btn-secondary btn-sm">Network</button>
                    <button onclick="quickAction('${machine.id}', 'software')" ${disabled ? 'disabled' : ''} class="btn btn-secondary btn-sm">Software</button>
                    ${isWindows ? `<button onclick="quickAction('${machine.id}', 'winupdates')" ${disabled ? 'disabled' : ''} class="btn btn-info btn-sm">Win Updates</button>` : ''}
                    <button onclick="showAlertsModal('${machine.id}')" class="btn btn-secondary btn-sm">Alerts</button>
                    <button onclick="updateSingleAgent('${machine.id}')" ${disabled ? 'disabled' : ''} class="btn btn-warning btn-sm">Update</button>
                    <button onclick="uninstallAgent('${machine.id}')" ${disabled ? 'disabled' : ''} class="btn btn-danger btn-sm">Uninstall</button>
                </div>
            `;
        }

        function renderCommandSection(machine) {
            const disabled = machine.status === 'offline';
            
            return `
                <div style="border-top: 1px solid var(--border); padding-top: 1rem;">
                    <div class="flex">
                        <input type="text" id="cmd-${machine.id}" placeholder="Enter command..." class="form-input" ${disabled ? 'disabled' : ''} style="flex: 1; margin-right: 0.5rem;">
                        <button onclick="executeCommand('${machine.id}')" ${disabled ? 'disabled' : ''} class="btn btn-primary">Execute</button>
                    </div>
                    <div id="result-${machine.id}" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); font-family: monospace; white-space: pre-wrap;"></div>
                </div>
            `;
        }

        // Quick actions and command execution
        function quickAction(machineId, action) {
            const commands = {
                'shutdown': {
                    'Windows': 'shutdown /s /t 30 /c "Remote shutdown in 30 seconds"',
                    'Linux': 'sudo shutdown -h +1 "Remote shutdown in 1 minute"'
                },
                'reboot': {
                    'Windows': 'shutdown /r /t 30',
                    'Linux': 'sudo reboot'
                },
                'processes': {
                    'Windows': 'tasklist /fo table',
                    'Linux': 'ps aux --sort=-%cpu | head -20'
                },
                'services': {
                    'Windows': 'sc query state= all',
                    'Linux': 'systemctl list-units --type=service --state=running'
                },
                'network': {
                    'Windows': 'ipconfig /all && netstat -an | findstr LISTEN',
                    'Linux': 'ip addr show && ss -tuln'
                },
                'software': {
                    'Windows': 'wmic product get name,version /format:table',
                    'Linux': 'dpkg -l | head -20'
                },
                'winupdates': {
                    'Windows': 'powershell "$Session = New-Object -ComObject Microsoft.Update.Session; $Searcher = $Session.CreateUpdateSearcher(); $SearchResult = $Searcher.Search(\\"IsInstalled=0\\"); if($SearchResult.Updates.Count -eq 0) { Write-Output \\"No updates available\\" } else { $SearchResult.Updates | Select-Object Title, Description, @{Name=\\"Size\\";Expression={[math]::Round($_.MaxDownloadSize/1MB,2)}} | Format-Table -AutoSize }"',
                    'Linux': 'echo "Windows Updates not available on Linux"'
                }
            };
            
            const machine = machines.find(m => m.id === machineId);
            if (!machine) return;
            
            const platform = machine.platform.includes('Windows') ? 'Windows' : 'Linux';
            const command = commands[action][platform];
            
            if (action === 'shutdown' || action === 'reboot') {
                if (!confirm(`${action} ${machine.hostname}?`)) return;
                executeCommandDirect(machineId, command, false);
            } else {
                executeCommandDirect(machineId, command, true);
            }
        }

        async function executeCommand(machineId) {
            const input = document.getElementById(`cmd-${machineId}`);
            const command = input.value.trim();
            if (!command) return;
            
            const machine = machines.find(m => m.id === machineId);
            document.getElementById('modalTitle').textContent = `${machine.hostname} - ${command}`;
            document.getElementById('modalOutput').textContent = 'Executing command...';
            document.getElementById('commandModal').style.display = 'block';

            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId, command })
                });

                const result = await response.json();
                if (result.success) {
                    pollForCommandResult(result.commandId, machine.hostname);
                    input.value = '';
                } else {
                    document.getElementById('modalOutput').textContent = `Error: ${result.error}`;
                }
            } catch (error) {
                document.getElementById('modalOutput').textContent = `Error: ${error.message}`;
            }
        }

        async function executeCommandDirect(machineId, command, showInModal = false) {
            const machine = machines.find(m => m.id === machineId);
            
            if (showInModal) {
                document.getElementById('modalTitle').textContent = `${machine.hostname} - ${command}`;
                document.getElementById('modalOutput').textContent = 'Executing command...';
                document.getElementById('commandModal').style.display = 'block';
            }
            
            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId, command })
                });

                const result = await response.json();
                if (result.success && showInModal) {
                    pollForCommandResult(result.commandId, machine.hostname);
                } else if (!result.success) {
                    if (showInModal) {
                        document.getElementById('modalOutput').textContent = `Error: ${result.error}`;
                    }
                }
            } catch (error) {
                if (showInModal) {
                    document.getElementById('modalOutput').textContent = `Error: ${error.message}`;
                }
            }
        }

        async function pollForCommandResult(commandId, hostname) {
            let attempts = 0;
            const maxAttempts = 20;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/command-result/${commandId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const result = data.result.result;
                        let output = '';
                        
                        if (result.stdout) output += result.stdout;
                        if (result.stderr) output += '\\n--- STDERR ---\\n' + result.stderr;
                        if (result.error) output = 'Error: ' + result.error;
                        if (result.returncode !== undefined) output += `\\n--- Exit Code: ${result.returncode} ---`;
                        
                        document.getElementById('modalOutput').textContent = output || 'No output';
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 500);
                    } else {
                        document.getElementById('modalOutput').textContent = 'Command timed out';
                    }
                } catch (error) {
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 500);
                    } else {
                        document.getElementById('modalOutput').textContent = 'Failed to retrieve result';
                    }
                }
            };
            
            poll();
        }

        // Update functions
        async function checkForUpdates() {
            const status = document.getElementById('update-status');
            status.textContent = 'Checking for updates...';
            
            try {
                const response = await fetch('/api/update-check');
                const result = await response.json();
                
                if (result.hasUpdate) {
                    status.textContent = `Update available: ${result.currentVersion} -> ${result.latestVersion}`;
                    status.className = 'text-warning';
                } else {
                    status.textContent = 'No updates available';
                    status.className = 'text-success';
                }
            } catch (error) {
                status.textContent = `Update check failed: ${error.message}`;
                status.className = 'text-danger';
            }
        }

        async function updateAllAgents() {
            const status = document.getElementById('update-status');
            status.textContent = 'Sending update request...';
            
            try {
                const response = await fetch('/api/update-agents', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    status.textContent = `Update sent to ${result.agentsNotified} agents`;
                    status.className = 'text-info';
                } else {
                    status.textContent = 'Failed to send update request';
                    status.className = 'text-danger';
                }
            } catch (error) {
                status.textContent = `Update failed: ${error.message}`;
                status.className = 'text-danger';
            }
        }

        async function updateSingleAgent(machineId) {
            const machine = machines.find(m => m.id === machineId);
            if (!machine || !confirm(`Update agent on ${machine.hostname}?`)) return;
            
            try {
                const response = await fetch('/api/update-single-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Update request sent');
                } else {
                    alert(`Failed: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Utility functions
        function formatBytes(bytes) {
            if (!bytes) return 'Unknown';
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        }

        function selectGroup(groupName, element) {
            selectedGroup = groupName;
            
            // Remove active styling from all groups
            document.querySelectorAll('.group').forEach(g => {
                g.classList.remove('active');
                g.style.background = '';
                g.style.color = '';
            });
            
            // Add active styling to selected group
            if (element && element.classList) {
                element.classList.add('active');
                element.style.background = 'var(--primary)';
                element.style.color = 'white';
                
                // Special handling for All Machines group
                if (groupName === 'all') {
                    const title = element.querySelector('#all-title');
                    const count = element.querySelector('#all-count');
                    if (title) title.style.color = 'white';
                    if (count) count.style.color = 'rgba(255,255,255,0.8)';
                }
            }
            
            renderMachines();
        }

        function getFilteredMachines() {
            if (selectedGroup === 'all') return machines;
            return machines.filter(m => groups[selectedGroup]?.includes(m.hostname));
        }

        function renderTableView(container, filteredMachines) {
            if (filteredMachines.length === 0) {
                container.innerHTML = '<div class="card"><div class="card-body text-center text-muted">No machines in this group</div></div>';
                return;
            }
            
            const tableHtml = `
                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Machine</th>
                                    <th>Status</th>
                                    <th>Platform</th>
                                    <th>CPU</th>
                                    <th>Memory</th>
                                    <th>Disk</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredMachines.map(machine => {
                                    const metrics = machine.metrics || {};
                                    const disabled = machine.status === 'offline';
                                    
                                    return `
                                        <tr>
                                            <td><strong>${machine.hostname}</strong></td>
                                            <td>
                                                <div class="flex" style="align-items: center; gap: 0.5rem;">
                                                    <div class="status-dot status-${machine.status}"></div>
                                                    <span class="badge badge-${machine.status === 'online' ? 'success' : 'danger'}">${machine.status}</span>
                                                </div>
                                            </td>
                                            <td>${machine.platform}</td>
                                            <td>${metrics.cpu_percent ? metrics.cpu_percent.toFixed(1) + '%' : 'N/A'}</td>
                                            <td>${metrics.memory_percent ? metrics.memory_percent.toFixed(1) + '%' : 'N/A'}</td>
                                            <td>${metrics.disk_percent ? metrics.disk_percent.toFixed(1) + '%' : 'N/A'}</td>
                                            <td>
                                                <div class="flex">
                                                    <button onclick="quickAction('${machine.id}', 'processes')" ${disabled ? 'disabled' : ''} class="btn btn-info btn-sm">Proc</button>
                                                    <button onclick="quickAction('${machine.id}', 'reboot')" ${disabled ? 'disabled' : ''} class="btn btn-warning btn-sm">Reboot</button>
                                                    <button onclick="updateSingleAgent('${machine.id}')" ${disabled ? 'disabled' : ''} class="btn btn-success btn-sm">Update</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        function closeModal() {
            document.getElementById('commandModal').style.display = 'none';
        }
        
        // Alerts configuration
        let currentAlertMachineId = null;
        
        async function showAlertsModal(machineId) {
            currentAlertMachineId = machineId;
            const machine = machines.find(m => m.id === machineId);
            
            document.getElementById('alertsModalTitle').textContent = `Configure Alerts - ${machine.hostname}`;
            
            // Load current alert settings
            try {
                const response = await fetch(`/api/machine-alerts/${machineId}`);
                if (response.ok) {
                    const alerts = await response.json();
                    
                    document.getElementById('alertsEnabled').checked = alerts.enabled || false;
                    document.getElementById('cpuThreshold').value = alerts.cpuThreshold || 90;
                    document.getElementById('memoryThreshold').value = alerts.memoryThreshold || 90;
                    document.getElementById('diskThreshold').value = alerts.diskThreshold || 90;
                    document.getElementById('offlineAlert').checked = alerts.offlineAlert !== false;
                    document.getElementById('onlineAlert').checked = alerts.onlineAlert || false;
                } else {
                    // Default values if no settings exist
                    document.getElementById('alertsEnabled').checked = false;
                    document.getElementById('cpuThreshold').value = 90;
                    document.getElementById('memoryThreshold').value = 90;
                    document.getElementById('diskThreshold').value = 90;
                    document.getElementById('offlineAlert').checked = true;
                    document.getElementById('onlineAlert').checked = false;
                }
                
                toggleAlertsConfig();
            } catch (error) {
                console.error('Error loading alerts:', error);
                // Default values if error
                document.getElementById('alertsEnabled').checked = false;
                document.getElementById('cpuThreshold').value = 90;
                document.getElementById('memoryThreshold').value = 90;
                document.getElementById('diskThreshold').value = 90;
                document.getElementById('offlineAlert').checked = true;
                document.getElementById('onlineAlert').checked = false;
                toggleAlertsConfig();
            }
            
            document.getElementById('alertsModal').style.display = 'block';
        }
        
        function toggleAlertsConfig() {
            const enabled = document.getElementById('alertsEnabled').checked;
            document.getElementById('alertsConfig').style.display = enabled ? 'block' : 'none';
        }
        
        async function saveAlerts() {
            if (!currentAlertMachineId) return;
            
            const alertConfig = {
                enabled: document.getElementById('alertsEnabled').checked,
                cpuThreshold: parseInt(document.getElementById('cpuThreshold').value),
                memoryThreshold: parseInt(document.getElementById('memoryThreshold').value),
                diskThreshold: parseInt(document.getElementById('diskThreshold').value),
                offlineAlert: document.getElementById('offlineAlert').checked,
                onlineAlert: document.getElementById('onlineAlert').checked
            };
            
            try {
                const response = await fetch(`/api/machine-alerts/${currentAlertMachineId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(alertConfig)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Alert configuration saved successfully');
                    closeAlertsModal();
                } else {
                    alert('Failed to save alert configuration: ' + result.error);
                }
            } catch (error) {
                alert('Error saving alert configuration: ' + error.message);
            }
        }
        
        function closeAlertsModal() {
            document.getElementById('alertsModal').style.display = 'none';
            currentAlertMachineId = null;
        }

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login';
                });
        }

        // Groups management
        async function loadDatabaseGroups() {
            try {
                const response = await fetch('/api/groups');
                const dbGroups = await response.json();
                
                groups = { 'Unknown': [] };
                for (const group of dbGroups) {
                    const membersResponse = await fetch(`/api/groups/${group.id}/members`);
                    const members = await membersResponse.json();
                    groups[group.name] = members.map(m => m.hostname);
                }
                renderGroups();
            } catch (error) {
                console.error('Failed to load groups:', error);
                groups = { 'Unknown': [] };
            }
        }

        function renderGroups() {
            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';
            
            Object.keys(groups).forEach(groupName => {
                if (groupName === 'Unknown') return; // Skip Unknown group
                
                let groupMachines = machines.filter(m => groups[groupName]?.includes(m.hostname));
                const onlineCount = groupMachines.filter(m => m.status === 'online').length;
                
                const div = document.createElement('div');
                div.className = 'cursor-pointer p-2 rounded mb-2';
                div.style.border = '1px solid var(--border)';
                div.onclick = (e) => selectGroup(groupName, div);
                
                if (selectedGroup === groupName) {
                    div.style.background = 'var(--primary)';
                    div.style.color = 'white';
                }
                
                div.innerHTML = `
                    <div>${groupName}</div>
                    <div class="text-muted" style="font-size: 0.875rem; ${selectedGroup === groupName ? 'color: rgba(255,255,255,0.8);' : ''}">${onlineCount}/${groupMachines.length} online</div>
                `;
                
                groupsList.appendChild(div);
            });
            
            // Update All Machines count
            const allOnline = machines.filter(m => m.status === 'online').length;
            document.getElementById('all-count').textContent = `${allOnline}/${machines.length} machines`;
        }
        
        // Metric graphs
        async function showMetricGraph(machineId, metricType, hostname) {
            // Store for modal refresh
            window.currentMachineId = machineId;
            window.currentMetricType = metricType;
            
            try {
                const response = await fetch(`/api/metrics/${machineId}`);
                const metrics = await response.json();
                
                if (metrics.error) {
                    alert('Failed to load metrics: ' + metrics.error);
                    return;
                }
                
                const labels = metrics.map(m => new Date(m.timestamp).toLocaleString());
                let data, label, color;
                
                switch(metricType) {
                    case 'cpu':
                        data = metrics.map(m => m.cpu_percent);
                        label = 'CPU Usage (%)';
                        color = 'var(--warning)';
                        break;
                    case 'memory':
                        data = metrics.map(m => m.memory_percent);
                        label = 'Memory Usage (%)';
                        color = 'var(--success)';
                        break;
                    case 'disk':
                        data = metrics.map(m => m.disk_percent);
                        label = 'Disk Usage (%)';
                        color = 'var(--danger)';
                        break;
                    case 'process':
                        data = metrics.map(m => m.process_count);
                        label = 'Process Count';
                        color = 'var(--info)';
                        break;
                }
                
                showGraphModal(hostname, label, labels, data, color);
                
            } catch (error) {
                alert('Failed to load metric graph: ' + error.message);
            }
        }
        
        async function refreshMetricGraph() {
            if (!window.currentMetricModal || !window.metricChart) return;
            
            try {
                const response = await fetch(`/api/metrics/${window.currentMetricModal.machineId}`);
                const metrics = await response.json();
                
                if (metrics.error) return;
                
                const labels = metrics.map(m => new Date(m.timestamp).toLocaleString());
                let data;
                
                switch(window.currentMetricModal.metricType) {
                    case 'cpu': data = metrics.map(m => m.cpu_percent); break;
                    case 'memory': data = metrics.map(m => m.memory_percent); break;
                    case 'disk': data = metrics.map(m => m.disk_percent); break;
                    case 'process': data = metrics.map(m => m.process_count); break;
                    default: return;
                }
                
                // Update chart data
                window.metricChart.data.labels = labels;
                window.metricChart.data.datasets[0].data = data;
                window.metricChart.update();
                
            } catch (error) {
                console.error('Failed to refresh graph:', error);
            }
        }
        
        function toggleRealtimeMetrics() {
            if (!window.currentMetricModal) return;
            
            const btn = document.getElementById('realtimeBtn');
            
            if (window.currentMetricModal.isRealtime) {
                // Turn off real-time
                clearInterval(window.currentMetricModal.interval);
                window.currentMetricModal.isRealtime = false;
                btn.textContent = 'Real-time: OFF';
                btn.className = 'btn btn-info btn-sm';
            } else {
                // Turn on real-time
                window.currentMetricModal.isRealtime = true;
                btn.textContent = 'Real-time: ON';
                btn.className = 'btn btn-warning btn-sm';
                
                // Refresh every 10 seconds
                window.currentMetricModal.interval = setInterval(refreshMetricGraph, 10000);
            }
        }
        
        function showGraphModal(hostname, label, labels, data, color) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${hostname} - ${label} (Last 24 Hours)</h3>
                            <div class="flex">
                                <button class="btn btn-success btn-sm" onclick="refreshMetricGraph()">Refresh</button>
                                <button class="btn btn-info btn-sm" id="realtimeBtn" onclick="toggleRealtimeMetrics()">Real-time: OFF</button>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <canvas id="metricChart" style="height: 500px;"></canvas>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            // Store modal data for refresh/realtime
            window.currentMetricModal = {
                hostname,
                label,
                color,
                machineId: window.currentMachineId,
                metricType: window.currentMetricType,
                isRealtime: false,
                interval: null
            };
            
            // Get actual CSS color values
            const getColor = (cssVar) => {
                return getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
            };
            
            const actualColor = color.startsWith('var(') ? getColor(color.slice(4, -1)) : color;
            
            // Create chart
            const ctx = document.getElementById('metricChart').getContext('2d');
            window.metricChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: actualColor,
                        backgroundColor: actualColor + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: actualColor,
                        pointBorderColor: actualColor,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: label.includes('%') ? 100 : undefined,
                            grid: {
                                color: getColor('--border')
                            },
                            ticks: {
                                color: getColor('--text-secondary')
                            }
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: getColor('--text-primary')
                            }
                        }
                    }
                }
            });
        }

        // Search functionality
        function filterContent() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                // Show all groups
                document.querySelectorAll('.group').forEach(g => g.style.display = 'block');
            } else {
                // Filter groups
                document.querySelectorAll('.group').forEach(group => {
                    const groupText = group.textContent.toLowerCase();
                    group.style.display = groupText.includes(searchTerm) ? 'block' : 'none';
                });
            }
            
            // Re-render machines with search filter
            renderMachines();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMachines();
            loadDatabaseGroups();
            
            // Set initial active state for All Machines
            const allGroup = document.getElementById('all-group');
            if (allGroup) {
                allGroup.style.background = 'var(--primary)';
                allGroup.style.color = 'white';
                const title = allGroup.querySelector('#all-title');
                const count = allGroup.querySelector('#all-count');
                if (title) title.style.color = 'white';
                if (count) count.style.color = 'rgba(255,255,255,0.8)';
            }
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                loadMachines();
                renderGroups();
            }, 10000);
            
            // Close modals on outside click
            window.onclick = function(event) {
                const commandModal = document.getElementById('commandModal');
                const alertsModal = document.getElementById('alertsModal');
                
                if (event.target === commandModal) {
                    closeModal();
                }
                if (event.target === alertsModal) {
                    closeAlertsModal();
                }
            };
            
            // Add event listener for alerts checkbox
            document.getElementById('alertsEnabled').addEventListener('change', toggleAlertsConfig);
        });
    </script>
</body>
</html>