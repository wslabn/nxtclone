<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Groups - SysWatch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-desktop me-2"></i>SysWatch
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/groups.html">Groups</a>
                <a class="nav-link" href="/admin">Admin</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Agent Groups</h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreateGroupModal()">
                            <i class="fas fa-plus"></i> New Group
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="groupsList"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Group Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="groupDetails">
                            <p class="text-muted">Select a group to view details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label class="form-label">Group Name</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="groupColor" value="#007bff">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Machine Modal -->
    <div class="modal fade" id="addMachineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Machine to Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Machine</label>
                        <select class="form-select" id="machineSelect">
                            <option value="">Choose a machine...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addMachineToGroup()">Add Machine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Command Modal -->
    <div class="modal fade" id="groupCommandModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Execute Command on Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Command</label>
                        <input type="text" class="form-control" id="groupCommand" placeholder="Enter command to execute on all group members">
                    </div>
                    <div id="groupCommandResults"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="executeGroupCommand()">Execute</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let groups = [];
        let machines = [];
        let selectedGroupId = null;

        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                groups = await response.json();
                renderGroups();
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadMachines() {
            try {
                const response = await fetch('/api/machines');
                machines = await response.json();
            } catch (error) {
                console.error('Error loading machines:', error);
            }
        }

        function renderGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            groups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'border rounded p-3 mb-2 cursor-pointer';
                groupElement.style.borderColor = group.color;
                groupElement.onclick = () => selectGroup(group.id);
                
                groupElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1" style="color: ${group.color}">${group.name}</h6>
                            <small class="text-muted">${group.member_count} members</small>
                        </div>
                        <span class="badge" style="background-color: ${group.color}">${group.member_count}</span>
                    </div>
                    ${group.description ? `<p class="mb-0 mt-2 small text-muted">${group.description}</p>` : ''}
                `;
                
                groupsList.appendChild(groupElement);
            });
        }

        async function selectGroup(groupId) {
            selectedGroupId = groupId;
            const group = groups.find(g => g.id === groupId);
            
            try {
                const response = await fetch(`/api/groups/${groupId}/members`);
                const members = await response.json();
                
                const groupDetails = document.getElementById('groupDetails');
                groupDetails.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 style="color: ${group.color}">${group.name}</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="showAddMachineModal()">
                                <i class="fas fa-plus"></i> Add Machine
                            </button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="showGroupCommandModal()">
                                <i class="fas fa-terminal"></i> Execute Command
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showGroupConfigModal()">
                                <i class="fas fa-cog"></i> Configure
                            </button>
                        </div>
                    </div>
                    ${group.description ? `<p class="text-muted mb-3">${group.description}</p>` : ''}
                    
                    <h6>Members (${members.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Hostname</th>
                                    <th>Platform</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${members.map(member => `
                                    <tr>
                                        <td>${member.hostname}</td>
                                        <td>${member.platform}</td>
                                        <td>
                                            <span class="badge ${member.status === 'online' ? 'bg-success' : 'bg-danger'}">
                                                ${member.status}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-danger btn-sm" onclick="removeMemberFromGroup('${member.id}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading group members:', error);
            }
        }

        function showCreateGroupModal() {
            new bootstrap.Modal(document.getElementById('createGroupModal')).show();
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;
            const color = document.getElementById('groupColor').value;

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, color })
                });

                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
                    document.getElementById('createGroupForm').reset();
                    loadGroups();
                } else {
                    alert('Error creating group: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        }

        function showAddMachineModal() {
            const machineSelect = document.getElementById('machineSelect');
            machineSelect.innerHTML = '<option value="">Choose a machine...</option>';
            
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.hostname} (${machine.platform})`;
                machineSelect.appendChild(option);
            });
            
            new bootstrap.Modal(document.getElementById('addMachineModal')).show();
        }

        async function addMachineToGroup() {
            const machineId = document.getElementById('machineSelect').value;
            if (!machineId || !selectedGroupId) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });

                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addMachineModal')).hide();
                    selectGroup(selectedGroupId);
                    loadGroups();
                } else {
                    alert('Error adding machine to group: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding machine to group:', error);
                alert('Error adding machine to group');
            }
        }

        async function removeMemberFromGroup(machineId) {
            if (!confirm('Remove this machine from the group?')) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/members/${machineId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    selectGroup(selectedGroupId);
                    loadGroups();
                } else {
                    alert('Error removing machine from group: ' + result.error);
                }
            } catch (error) {
                console.error('Error removing machine from group:', error);
                alert('Error removing machine from group');
            }
        }

        function showGroupCommandModal() {
            new bootstrap.Modal(document.getElementById('groupCommandModal')).show();
        }

        async function executeGroupCommand() {
            const command = document.getElementById('groupCommand').value;
            if (!command || !selectedGroupId) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });

                const result = await response.json();
                const resultsDiv = document.getElementById('groupCommandResults');
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            Command sent to ${result.results.filter(r => r.status === 'sent').length} machines
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr><th>Machine</th><th>Status</th><th>Command ID</th></tr>
                                </thead>
                                <tbody>
                                    ${result.results.map(r => `
                                        <tr>
                                            <td>${r.machineId}</td>
                                            <td><span class="badge ${r.status === 'sent' ? 'bg-success' : 'bg-warning'}">${r.status}</span></td>
                                            <td>${r.commandId || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Error executing group command:', error);
                document.getElementById('groupCommandResults').innerHTML = 
                    `<div class="alert alert-danger">Error executing command</div>`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGroups();
            loadMachines();
        });
    </script>
</body>
</html>