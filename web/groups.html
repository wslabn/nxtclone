<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Groups - SysWatch</title>
    <link rel="stylesheet" href="/theme.css">
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #212529;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1e1e1e;
                --card-bg: #252526;
                --text-color: #cccccc;
                --border-color: #3c3c3c;
                --shadow: 0 2px 4px rgba(0,0,0,0.5);
            }
        }
        body { font-family: Arial, sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); }
        .navbar { background: var(--card-bg); padding: 15px 0; box-shadow: var(--shadow); margin-bottom: 20px; }
        .navbar-brand { font-size: 20px; font-weight: bold; color: var(--text-color); text-decoration: none; }
        .navbar-nav { display: flex; list-style: none; margin: 0; padding: 0; margin-left: auto; }
        .nav-link { color: var(--text-color); text-decoration: none; padding: 8px 15px; border-radius: 4px; }
        .nav-link:hover { background: var(--bg-color); }
        .nav-link.active { background: #007bff; color: white; }
        .navbar-expand-lg { display: flex; align-items: center; justify-content: space-between; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-weight: bold; }
        .card-body { padding: 20px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .form-control { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color); }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
        .mb-3 { margin-bottom: 15px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 8px; border-bottom: 1px solid var(--border-color); }
        .table th { background: var(--bg-color); }
        .badge { padding: 2px 6px; border-radius: 3px; font-size: 11px; }
        .bg-success { background: #28a745; color: white; }
        .bg-danger { background: #dc3545; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-dialog { margin: 50px auto; max-width: 500px; }
        .modal-content { background: var(--card-bg); border-radius: 8px; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); text-align: right; }
        .btn-close { background: none; border: none; font-size: 20px; cursor: pointer; }
        .row { display: flex; gap: 20px; }
        .col-md-4 { flex: 0 0 33.333%; }
        .col-md-8 { flex: 0 0 66.666%; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .text-muted { color: #6c757d; }
        .cursor-pointer { cursor: pointer; }
        .group-item { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 10px; cursor: pointer; }
        .group-item:hover { background: var(--bg-color); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg" style="background: var(--card-bg); padding: 15px 0; box-shadow: var(--shadow); margin-bottom: 20px;">
        <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
            <a class="navbar-brand" href="/" style="font-size: 20px; font-weight: bold; color: var(--text-color); text-decoration: none;">üñ•Ô∏è SysWatch Groups</a>
            <div class="navbar-nav" style="display: flex; list-style: none; margin: 0; padding: 0;">
                <a class="nav-link" href="/" style="color: var(--text-color); text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px;">Dashboard</a>
                <a class="nav-link active" href="/groups.html" style="color: white; background: #007bff; text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px;">Groups</a>
                <a class="nav-link" href="/admin" style="color: var(--text-color); text-decoration: none; padding: 8px 15px; border-radius: 4px; margin-right: 5px;">Admin</a>
                <button onclick="logout()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Agent Groups</h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreateGroupModal()">
                            <i class="fas fa-plus"></i> New Group
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="groupsList"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Group Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="groupDetails">
                            <p class="text-muted">Select a group to view details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label class="form-label">Group Name</label>
                            <input type="text" class="form-control" id="groupName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="groupColor" value="#007bff">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Machine Modal -->
    <div class="modal fade" id="addMachineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Machine to Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Machine</label>
                        <select class="form-select" id="machineSelect">
                            <option value="">Choose a machine...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addMachineToGroup()">Add Machine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Command Modal -->
    <div class="modal fade" id="groupCommandModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Execute Command on Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Command</label>
                        <input type="text" class="form-control" id="groupCommand" placeholder="Enter command to execute on all group members">
                    </div>
                    <div id="groupCommandResults"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="executeGroupCommand()">Execute</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        let groups = [];
        let machines = [];
        let selectedGroupId = null;

        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                groups = await response.json();
                renderGroups();
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadMachines() {
            try {
                const response = await fetch('/api/machines');
                machines = await response.json();
            } catch (error) {
                console.error('Error loading machines:', error);
            }
        }

        function renderGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            groups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'border rounded p-3 mb-2 cursor-pointer';
                groupElement.style.borderColor = group.color;
                groupElement.onclick = () => selectGroup(group.id);
                
                groupElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1" style="color: ${group.color}">${group.name}</h6>
                            <small class="text-muted">${group.member_count} members</small>
                        </div>
                        <span class="badge" style="background-color: ${group.color}">${group.member_count}</span>
                    </div>
                    ${group.description ? `<p class="mb-0 mt-2 small text-muted">${group.description}</p>` : ''}
                `;
                
                groupsList.appendChild(groupElement);
            });
        }

        async function selectGroup(groupId) {
            selectedGroupId = groupId;
            const group = groups.find(g => g.id === groupId);
            
            try {
                const response = await fetch(`/api/groups/${groupId}/members`);
                const members = await response.json();
                
                const groupDetails = document.getElementById('groupDetails');
                groupDetails.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 style="color: ${group.color}">${group.name}</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="showAddMachineModal()">
                                <i class="fas fa-plus"></i> Add Machine
                            </button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="showGroupCommandModal()">
                                <i class="fas fa-terminal"></i> Execute Command
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showGroupConfigModal()">
                                <i class="fas fa-cog"></i> Configure
                            </button>
                        </div>
                    </div>
                    ${group.description ? `<p class="text-muted mb-3">${group.description}</p>` : ''}
                    
                    <h6>Members (${members.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Hostname</th>
                                    <th>Platform</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${members.map(member => `
                                    <tr>
                                        <td>${member.hostname}</td>
                                        <td>${member.platform}</td>
                                        <td>
                                            <span class="badge ${member.status === 'online' ? 'bg-success' : 'bg-danger'}">
                                                ${member.status}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-danger btn-sm" onclick="removeMemberFromGroup('${member.id}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading group members:', error);
            }
        }

        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'block';
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;
            const color = document.getElementById('groupColor').value;

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, color })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('createGroupModal').style.display = 'none';
                    document.getElementById('createGroupForm').reset();
                    loadGroups();
                } else {
                    alert('Error creating group: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        }

        function showAddMachineModal() {
            const machineSelect = document.getElementById('machineSelect');
            machineSelect.innerHTML = '<option value="">Choose a machine...</option>';
            
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.hostname} (${machine.platform})`;
                machineSelect.appendChild(option);
            });
            
            document.getElementById('addMachineModal').style.display = 'block';
        }

        async function addMachineToGroup() {
            const machineId = document.getElementById('machineSelect').value;
            if (!machineId || !selectedGroupId) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machineId })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('addMachineModal').style.display = 'none';
                    selectGroup(selectedGroupId);
                    loadGroups();
                } else {
                    alert('Error adding machine to group: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding machine to group:', error);
                alert('Error adding machine to group');
            }
        }

        async function removeMemberFromGroup(machineId) {
            if (!confirm('Remove this machine from the group?')) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/members/${machineId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    selectGroup(selectedGroupId);
                    loadGroups();
                } else {
                    alert('Error removing machine from group: ' + result.error);
                }
            } catch (error) {
                console.error('Error removing machine from group:', error);
                alert('Error removing machine from group');
            }
        }

        function showGroupCommandModal() {
            document.getElementById('groupCommandModal').style.display = 'block';
        }

        async function executeGroupCommand() {
            const command = document.getElementById('groupCommand').value;
            if (!command || !selectedGroupId) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });

                const result = await response.json();
                const resultsDiv = document.getElementById('groupCommandResults');
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            Command sent to ${result.results.filter(r => r.status === 'sent').length} machines
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr><th>Machine</th><th>Status</th><th>Command ID</th></tr>
                                </thead>
                                <tbody>
                                    ${result.results.map(r => `
                                        <tr>
                                            <td>${r.machineId}</td>
                                            <td><span class="badge ${r.status === 'sent' ? 'bg-success' : 'bg-warning'}">${r.status}</span></td>
                                            <td>${r.commandId || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Error executing group command:', error);
                document.getElementById('groupCommandResults').innerHTML = 
                    `<div class="alert alert-danger">Error executing command</div>`;
            }
        }

        // Modal close functionality
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['createGroupModal', 'addMachineModal', 'groupCommandModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login';
                });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGroups();
            loadMachines();
            
            // Add close button handlers
            document.querySelectorAll('.btn-close').forEach(btn => {
                btn.onclick = () => {
                    const modal = btn.closest('.modal');
                    if (modal) modal.style.display = 'none';
                };
            });
            
            // Add cancel button handlers
            document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
                btn.onclick = () => {
                    const modal = btn.closest('.modal');
                    if (modal) modal.style.display = 'none';
                };
            });
        });
    </script>
</body>
</html>