<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysWatch Admin Panel</title>
    <link rel="stylesheet" href="/shared.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="/" class="navbar-brand">üñ•Ô∏è SysWatch Dashboard</a>
                <ul class="navbar-nav">
                    <li><a href="/" class="nav-link">Dashboard</a></li>
                    <li><a href="/groups.html" class="nav-link">Groups</a></li>
                    <li><a href="/admin" class="nav-link active">Admin</a></li>
                    <li><button onclick="logout()" class="btn btn-danger btn-sm">Logout</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="grid grid-2">
            <!-- Left Column -->
            <div>
                <!-- Change Password -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">Change Password</h3>
                    </div>
                    <div class="card-body">
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" id="currentPassword" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" id="newPassword" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password</label>
                                <input type="password" id="confirmPassword" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Change Password</button>
                            <div id="passwordMessage" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- Add User -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">Add User</h3>
                    </div>
                    <div class="card-body">
                        <form id="addUserForm">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" id="username" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" id="password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select id="role" class="form-input">
                                    <option value="admin">Admin</option>
                                    <option value="user">User</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Add User</button>
                            <div id="userMessage" class="mt-2"></div>
                        </form>
                    </div>
                </div>

                <!-- Discord Alerts -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Discord Alerts</h3>
                    </div>
                    <div class="card-body">
                        <form id="discordForm">
                            <div class="form-group">
                                <label class="form-label">Discord Webhook URL</label>
                                <input type="url" id="webhookUrl" class="form-input" placeholder="https://discord.com/api/webhooks/...">
                            </div>
                            <button type="submit" class="btn btn-info">Save Webhook</button>
                            <div id="discordMessage" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Server Logs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="flex flex-between">
                            <h3 class="card-title">Server Logs</h3>
                            <button onclick="viewLogs()" class="btn btn-secondary btn-sm">Toggle Logs</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="logsContainer" style="display: none;">
                            <div id="logsList" style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Users List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Users</h3>
                    </div>
                    <div class="card-body">
                        <div id="usersList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Change Password
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const message = document.getElementById('passwordMessage');
            
            if (newPass !== confirm) {
                message.innerHTML = '<div class="text-danger">Passwords do not match</div>';
                return;
            }
            
            try {
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: current, newPassword: newPass })
                });
                
                const result = await response.json();
                message.innerHTML = result.success ? 
                    '<div class="text-success">Password changed successfully</div>' :
                    `<div class="text-danger">${result.error}</div>`;
                    
                if (result.success) {
                    document.getElementById('changePasswordForm').reset();
                }
            } catch (error) {
                message.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
            }
        });
        
        // Add User
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const message = document.getElementById('userMessage');
            
            try {
                const response = await fetch('/api/add-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });
                
                const result = await response.json();
                message.innerHTML = result.success ? 
                    '<div class="text-success">User added successfully</div>' :
                    `<div class="text-danger">${result.error}</div>`;
                    
                if (result.success) {
                    document.getElementById('addUserForm').reset();
                    loadUsers();
                }
            } catch (error) {
                message.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
            }
        });
        
        // Load Users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                const container = document.getElementById('usersList');
                
                container.innerHTML = users.map(user => `
                    <div class="flex flex-between p-2 rounded mb-2" style="border: 1px solid var(--border);">
                        <div>
                            <div style="font-weight: 500;">${user.username}</div>
                            <div class="text-muted">${user.role}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.username}')" 
                                ${user.username === 'admin' ? 'disabled' : ''}>Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }
        
        // Delete User
        async function deleteUser(username) {
            if (!confirm(`Delete user ${username}?`)) return;
            
            try {
                const response = await fetch('/api/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadUsers();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Discord Webhook
        document.getElementById('discordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const webhookUrl = document.getElementById('webhookUrl').value;
            const message = document.getElementById('discordMessage');
            
            try {
                const response = await fetch('/api/discord-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ webhookUrl })
                });
                
                const result = await response.json();
                message.innerHTML = result.success ? 
                    '<div class="text-success">Discord webhook configured</div>' :
                    `<div class="text-danger">${result.error}</div>`;
            } catch (error) {
                message.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
            }
        });
        
        // View Logs
        async function viewLogs() {
            const container = document.getElementById('logsContainer');
            const logsList = document.getElementById('logsList');
            
            if (container.style.display === 'none') {
                try {
                    const response = await fetch('/api/logs');
                    const data = await response.json();
                    
                    if (data.logs) {
                        const logsHtml = data.logs.map(log => {
                            const time = new Date(log.timestamp).toLocaleString();
                            const levelColor = {
                                'error': 'var(--danger)',
                                'warn': 'var(--warning)',
                                'info': 'var(--info)',
                                'success': 'var(--success)'
                            }[log.level] || 'var(--text-primary)';
                            
                            return `<div style="margin: 0.5rem 0; color: var(--text-primary);">
                                <span style="color: var(--text-muted);">[${time}]</span> 
                                <span style="color: ${levelColor}; font-weight: bold;">[${log.level.toUpperCase()}]</span> 
                                ${log.message}
                            </div>`;
                        }).reverse().join('');
                        
                        logsList.innerHTML = logsHtml || '<div class="text-muted">No logs available</div>';
                    } else {
                        logsList.innerHTML = `<div class="text-danger">Error: ${data.error}</div>`;
                    }
                } catch (error) {
                    logsList.innerHTML = `<div class="text-danger">Failed to load logs: ${error.message}</div>`;
                }
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login';
                });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
    </script>
</body>
</html>