name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install pyinstaller psutil websockets requests pystray pillow
    
    - name: Build Windows executables
      run: |
        cd build
        python build-windows.py
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: |
          build/dist/syswatch-agent-windows.exe
          build/dist/syswatch-tray.exe
          build/dist/syswatch-agent-installer.exe
  
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install pyinstaller psutil websockets requests pystray pillow
    
    - name: Build Linux executables
      run: |
        cd build
        python build-linux.py
        chmod +x create-linux-installer.sh
        ./create-linux-installer.sh
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-executables
        path: |
          build/dist/syswatch-agent
          build/dist/syswatch-control
          build/dist/syswatch-agent-installer-linux
  
  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-executables
        path: ./windows-build/
    
    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-executables
        path: ./linux-build/
    
    - name: Create source package
      run: |
        mkdir -p dist
        cp -r server dist/
        cp -r agents dist/
        cp -r web dist/
        cp package.json dist/
        cp README.md dist/
        cp TROUBLESHOOTING.md dist/
        cd dist && zip -r ../syswatch-source-${{ github.ref_name }}.zip .
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: SysWatch ${{ github.ref_name }}
        body: |
          ## SysWatch Release ${{ github.ref_name }}
          
          ### Features
          - Remote monitoring and management
          - Cross-platform agents (Windows, Linux)
          - Real-time system metrics with scalable table view
          - Auto-update functionality
          - Web-based dashboard
          - System tray control applications
          
          ### Quick Installation
          **Windows:** Download and run `syswatch-agent-installer.exe` as administrator
          **Linux:** Download and run `sudo ./syswatch-agent-installer-linux ws://your-server:3000`
          
          ### Optional Control Apps
          **Windows:** Run `syswatch-tray.exe` for system tray control
          **Linux:** Run `./syswatch-control` for GUI/CLI management
          
          ### Auto-Update
          Agents automatically check for and install updates from this release.
        files: |
          windows-build/*
          linux-build/*
          syswatch-source-${{ github.ref_name }}.zip
        draft: false
        prerelease: false